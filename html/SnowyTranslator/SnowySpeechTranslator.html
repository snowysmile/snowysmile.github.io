<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="icon" href="static/Img/favicon/cat-in-leaves-512x512.png">
  <link rel="stylesheet" href="static/font.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
  <style>
    html, body {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .row-container {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
    }
    .row-container-left {
      width: 720px;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
    }
    .reading-container,
    .reading-container select,
    .reading-container button {
      font-size: 9px;
    }
    .reading-button-container button{
      width:22px;
    }
    .layout-container,
    .layout-container button {
      font-size: 12px;
    }

    table {
      border-collapse: collapse;
      border: 1px solid #777777;
    }
    th, td {
      border-bottom: 1px solid #ccc;
      text-align: center;
      vertical-align: middle;
      padding: 4px;
    }
    .input-table {
      table-layout: fixed;
    }
    .input-table button{
      vertical-align: middle;
      height: 28px;
    }
    .input-table select {
      vertical-align: middle;
      height: 28px;
      width: 36px;
      font-family: "Monaco", monospace;
    }
    @media screen and (max-width: 600px) {
      html, body {
        display: flex;
      }
      table {
        display: flex;
        flex-direction: column;
      }
      th, td {
        display: block;
        align-items: center;
        text-align: center;
        padding: 4px;
      }
      textarea {
        max-width: 96%;
        width: 96%;
      }
      iframe {
        width: 100%; /* Make the iframe responsive to its container width */
        max-width: 100%; /* Set a maximum width for the iframe */
        height: auto; /* Let the iframe adjust its height proportionally */
        display: block; /* Remove any extra spacing around the iframe */
        margin: 0 auto; /* Center the iframe horizontally */
      }
      .button-title {
        display: flex;
        justify-content: space-between;
      }
    }
    @media screen and (min-width: 601px) {
      .phone-button {
        display: none;
      }
    }

    rt {
      font-size: 0.8em;
    }
    input[type="range"] {
      height: 10px;
    }
    .svg-stroke-text{
      font-size:50px;
      text-anchor:middle;
      fill:red;
    }
    .svg-stroke-layer-A{
      stroke-width:0.1em;
      stroke:orange;
    }
    .svg-stroke-layer-B{
      stroke-width:0.2em;
      stroke:yellow;
    }
    .svg-stroke-layer-C{
      stroke-width:0.3em;
      stroke:blue;
    }
    .text-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      width: 1000px;
      height: 150px;
      max-width: 95%;
      width: 95%;
    }
    .stroke-text {
      position: relative;
      z-index: 0;
    }
    .stroke-text:before {
      content: attr(stroke-data);
      position: absolute;
      left: 0;
      top: 0;
      z-index: -1;
      -webkit-text-stroke: var(--stroke-width-layer-0) var(--stroke-color-layer-0);
    }
    .stroke-text:after {
      content: attr(stroke-data);
      position: absolute;
      left: 0;
      top: 0;
      z-index: -2;
      -webkit-text-stroke: var(--stroke-width-layer-1) var(--stroke-color-layer-1);
    }
    #jpExpAreaFrame {
      width: 1015px;
      border: 2px solid black;
      max-width: 96%;
      width: 96%;
    }
    #jpExpArea {
			margin-top: 10px;
			margin-bottom: 10px;
      width: 1000px;
      max-width: 96%;
      width: 96%;
    }
  </style>

  <script>
    var runningEnvironment = 0;
    if (window.location.protocol === "file:") {
      console.log("Running as a local file");
      runningEnvironment = 1;
    }
    else if (window.location.href.includes("localhost:")) {
      console.log("Running on localhost");
      runningEnvironment = 2;
    }
    else {
      console.log("Running on a web server");
      runningEnvironment = 3;
    }
  </script>
  <script>
    const topTranslationCounts = 2;
    var translationCounts = 2;
    var configCounts = 3;
    var defaultConfig =
    {
      pageColor: "#fffafa",
      curtainColor: "#9acd32",
      texts: ["„Åç„Çâ„Åç„Çâ„Å≤„Åã„Çã„ÄÅ„Åä„Åù„Çâ„ÅÆ„Åª„Åó„Çà„ÄÇ",
              "Twinkle, twinkle, little star, How I wonder what you are! ",
              "‰∏ÄÈñÉ‰∏ÄÈñÉ‰∫ÆÊô∂Êô∂ÔºåÊªøÂ§©ÈÉΩÊòØÂ∞èÊòüÊòü„ÄÇ"],
              // „Åæ„Å∞„Åü„Åç„Åó„Å¶„ÅØ„ÄÅ„Åø„Çì„Å™„Çí„Åø„Å¶„Çã„ÄÇ
              // Up above the world so high, Like a diamond in the sky.
              // ÊéõÂú®Â§©‰∏äÊîæÂÖâÊòéÔºåÂ•ΩÂÉèË®±Â§öÂ∞èÁúºÁùõ„ÄÇ
              // "1234567890 !@#$%^&*() abcdefg ABCDEFG",
      textFontColors: ["#000000", "#000000", "#000000"],
      textFontSizes: [20, 17, 14], //px
      textFontWeights: [500, 500, 500],
      textFontFamilies: ['NotoSansCJKjp', 'NotoSansCJKjp', 'NotoSansCJKjp'],
      textStrokeColors: [['#87ceeb', '#ffb7c5'], ['#87ceeb', '#ffb7c5'], ['#87ceeb', '#ffb7c5']],
      textStrokeWidths: [[0, 0], [0, 0], [0, 0]], //em
      textShadowColors: ["#ffeebb", "#ffeebb", "#ffeebb"],
      textShadowBlurRadius: [0, 0, 0], //em
      textMargins: [5, 5, 5], //px
      apiKeys: ["", "", "", ""],
      speechSplitInterval: 1000, //ms
      speechClearInterval: 360000, //ms
      languages: ['ja', 'en', 'zh-TW'],
      azureVoices: ['ja-JP-AoiNeural', 'en-US-AnaNeural', 'zh-CN-XiaoyouNeural'],
    }
    var configs = [
      {}, {}, {},
    ];
    var autoSID = 0;
    configs[autoSID] = defaultConfig;
  </script>
  <title>Snowy Speech Translator</title>
</head>
<body>
  <svg width="100%" viewBox="0 0 800 100" display="none">
    <text class="svg-stroke-text svg-stroke-layer-C" name="strokeTitle" x="50%" y="50%">
    </text>
    <text class="svg-stroke-text svg-stroke-layer-B" name="strokeTitle" x="50%" y="50%">
    </text>
    <text class="svg-stroke-text svg-stroke-layer-A" name="strokeTitle" x="50%" y="50%">
    </text>
    <text class="svg-stroke-text" name="strokeTitle" x="50%" y="50%">
    </text>
  </svg>

  <script>
    strokeTitles = document.querySelectorAll('.svg-stroke-text[name="strokeTitle"]');
      strokeTitles.forEach(function(element) {
        element.textContent = "My Speech Translator";
    });
  </script>

  <iframe id="jpExpWebTop" style="width:1000px; height:654px; margin-top:5px; margin-bottom:5px; display:none" src="https://ichi.moe/"></iframe>

  <div class="text-area">
    <div id="textMargin-0"> </div>
    <div class="stroke-text" id="text-0"> </div>
    <div id="textMargin-1"> </div>
    <div class="stroke-text" id="text-1"> </div>
    <div id="textMargin-2"> </div>
    <div class="stroke-text" id="text-2"> </div>
  </div>
  <script>
    $(function() {
      $('.text-area').resizable({
        touchAction: 'none',
        handles: 'se',
        resize: function(event, ui) {
        }
      });
    });
  </script>

  <script>
    async function ggSpeakAllScreenText(repeatTime=1) {
      ggAudioListTmp = [];
      await addToGgReadingList(ggAudioListTmp, 3);
      await ggSpeakReadingList(ggAudioListTmp, repeatTime);
    }
    async function msSpeakAllScreenText(repeatTime=1) {
      msAudioListTmp = [];
      await addToMsReadingList(msAudioListTmp, 3);
      await msSpeakReadingList(msAudioListTmp, repeatTime);
    }
    async function ggSpeakAllInputText(text, sourceLanguage, repeatTime) {
      if (ggAudioList.length === 0) {
        if (text != texts[0].textContent) {
          console.log("text != texts[0].textContent");
          await speechTranslate(text, sourceLanguage);
        }
        await addToGgReadingList(ggAudioList, 3);
        console.log("len after addToGgReadingList: ", ggAudioList.length);
      }
      await ggSpeakReadingList(ggAudioList, repeatTime);
    }
    async function msSpeakAllInputText(text, sourceLanguage, repeatTime) {
      if (msAudioList.length === 0) {
        if (text != texts[0].textContent) {
          console.log("text != texts[0].textContent");
          await speechTranslate(text, sourceLanguage);
        }
        await addToMsReadingList(msAudioList, 3);
      }
      await msSpeakReadingList(msAudioList, repeatTime);
    }
  </script>
  <div class="row-container" style="margin-top:5px; margin-bottom:5px;">
    <span class="reading-container">
      <button onclick="ggSpeakAllScreenText()">G</button>
      <button onclick="msSpeakAllScreenText()">M</button>
      <span style="margin-left:10px;" class="reading-button-container">
        <select id="readingSelect0">
          <option value="ja" selected>üáØüáµ</option>
          <option value="en">üá∫üá∏</option>
          <option value="zh-TW">üáπüáº</option>
        </select>
        <button onclick="ggSpeak(texts[0].textContent, this.previousElementSibling.value)">G</button>
        <button onclick="msSpeak(texts[0].textContent, this.previousElementSibling.previousElementSibling.value)">M</button>
      </span>
      <span style="margin-left:10px;" class="reading-button-container">
        <select id="readingSelect1">
          <option value="ja">üáØüáµ</option>
          <option value="en" selected>üá∫üá∏</option>
          <option value="zh-TW">üáπüáº</option>
        </select>
        <button onclick="ggSpeak(texts[1].textContent, this.previousElementSibling.value)">G</button>
        <button onclick="msSpeak(texts[1].textContent, this.previousElementSibling.previousElementSibling.value)">M</button>
      </span>
      <span style="margin-left:10px;" class="reading-button-container">
        <select id="readingSelect2">
          <option value="ja">üáØüáµ</option>
          <option value="en">üá∫üá∏</option>
          <option value="zh-TW" selected>üáπüáº</option>
        </select>
        <button onclick="ggSpeak(texts[2].textContent, this.previousElementSibling.value)">G</button>
        <button onclick="msSpeak(texts[2].textContent, this.previousElementSibling.previousElementSibling.value)">M</button>
      </span>
    </span>
  </div>

  <table class="input-table">
    <tr class="input-table-row" id="recognitionInputArea" style="display:block">
      <td class="button-title">
        <span>
          <button id="recognize-button" onclick="toggleRecognition(this.parentNode.parentNode.querySelector('select').value)" style="width: 148px;">‚ñ∂Ô∏è Start Recognizing</button>
            <select id="recognitionLanguageSelect">
              <option value="ja" selected>üáØüáµ</option>
              <option value="en">üá∫üá∏</option>
              <option value="zh-TW">üáπüáº</option>
            </select>
            <button name="languageDetectButton" onclick="toggleAutoLangaugeDetect(this)">üò¥</button>
        </span>
        <button class="phone-button" onclick="toggleWidgetArea('recognitionInputArea', 'toggleRecognitionInputArea-button', 'Recognition Ipt')">‚õî</button>
      </td>
      <td>
        <textarea id="recognitionResult" rows="2" cols="80"></textarea>
      </td>
      <td>
        <button name="translateButton" onclick="speechTranslate(this.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelector('select').value, this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === 'ü§î', recognitionLanguageSelect)">üî§</button>
        <button onclick="copyTextArea(this)">‚úÇÔ∏è</button>
        <button onclick="clearTextArea(this)">üÜë</button>
        <span class="readButtons">
          <button onclick="ggSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">Güîä</button>
          <button onclick="msSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">Müîä</button>
        </span>
      </td>
    </tr>

    <tr class="input-table-row" id="recordInputArea" style="display:none">
      <td class="button-title">
        <span>
          <button id="record-button" onclick="toggleRecord()" style="width: 148px;">‚ñ∂Ô∏è Start Recording</button>
          <select id="recordLanguageSelect">
            <option value="ja" selected>üáØüáµ</option>
            <option value="en">üá∫üá∏</option>
            <option value="zh-TW">üáπüáº</option>
          </select>
          <button name="languageDetectButton" onclick="toggleAutoLangaugeDetect(this)">üò¥</button>
        </span>
        <button class="phone-button" onclick="toggleWidgetArea('recordInputArea', 'toggleRecordInputArea-button', 'Record Ipt')">‚õî</button>
      </td>
      <td>
        <textarea id="recordResult" rows="2" cols="80"></textarea>
      </td>
      <td>
        <button name="translateButton" onclick="speechTranslate(this.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelector('select').value, this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === 'ü§î', recordLanguageSelect)">üî§</button>
        <button onclick="copyTextArea(this)">‚úÇÔ∏è</button>
        <button onclick="clearTextArea(this)">üÜë</button>
        <span class="readButtons">
          <button onclick="ggSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">Güîä</button>
          <button onclick="msSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">Müîä</button>
        </span>
      </td>
    </tr>

    <tr class="input-table-row" id="translationInputArea" style="display:none">
      <td class="button-title">
        <span>
          <button id="translate-button" onclick="speechTranslate(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelector('select').value, querySelector('button[name=\'languageDetectButton\']').innerHTML === 'ü§î', translationLanguageSelect)" style="width: 148px;"> Translate </button>
          <select id="translationLanguageSelect">
            <option value="ja">üáØüáµ</option>
            <option value="en" selected>üá∫üá∏</option>
            <option value="zh-TW">üáπüáº</option>
          </select>
          <button name="languageDetectButton" onclick="toggleAutoLangaugeDetect(this)">üò¥</button>
        </span>
        <button class="phone-button" onclick="toggleWidgetArea('translationInputArea', 'toggleTranslationInputArea-button', 'Translation Ipt')">‚õî</button>
      </td>
      <td>
        <textarea id="translateInput" rows="2" cols="80"></textarea>
      </td>
      <td>
        <button type="button" name="translateButton"
          onclick="speechTranslate(this.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelector('select').value, this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === 'ü§î', translationLanguageSelect)">üî§</button>
        <button onclick="copyTextArea(this)">‚úÇÔ∏è</button>
        <button onclick="clearTextArea(this)">üÜë</button>
        <span class="readButtons">
          <button onclick="ggSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">Güîä</button>
          <button onclick="msSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">Müîä</button>
        </span>
      </td>
    </tr>

    <tr class="input-table-row" id="jpExpInputArea" style="display:none">
      <form action="/process" method="post">
        <td class="button-title">
          <span>
            <button type="button" id="jpExp-button" onclick="japaneseExplanationEntrance()" style="width: 148px;">Japanese Explanation</button>
            <select id="jpExpLanguageSelect">
              <option value="ja" selected>üáØüáµ</option>
            </select>
          </span>
          <button type="button" class="phone-button" onclick="toggleWidgetArea('jpExpInputArea', 'toggleJpExpInputArea-button', 'JpExp Ipt')">‚õî</button>
        </td>
        <td>
          <textarea id="jpExpInput" rows="2" cols="85"></textarea>
        </td>
        <td>
          <button type="button" name="translateButton" onclick="speechTranslate(this.parentNode.parentNode.querySelector('textarea').value, 'ja')">üî§</button>
          <button type="button" onclick="copyTextArea(this)">‚úÇÔ∏è</button>
          <button type="button" onclick="clearTextArea(this)">üÜë</button>
          <span class="readButtons">
            <button type="button"  onclick="ggSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">Güîä</button>
            <button type="button" onclick="msSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">Müîä</button>
          </span>
        </td>
      </form>
    </tr>
  </table>

  <table class="input-table" style="margin-top: 3px; display:block;">
    <tr class="input-table-row" id="readingListInputArea">
      <td class="button-title">
        <span>
          <button type="button" name="translateButton"
            onclick="speechTranslate(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelector('select').value, this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === 'ü§î', translationLanguageSelect)">Ë®≥</button>
          <button id="addToReadingList-button" onclick="addToReadingList(ggAudioList, msAudioList, this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelectorAll('select')[0].value, 1,  this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === 'ü§î', readingListLanguageSelect)" > + </button>
          <button onclick="addToReadingList(ggAudioList, msAudioList, this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelectorAll('select')[0].value, 2,  this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === 'ü§î', readingListLanguageSelect)"> ++ </button>
          <button onclick="addToReadingList(ggAudioList, msAudioList, this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelectorAll('select')[0].value, 3,  this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === 'ü§î', readingListLanguageSelect)"> +++ </button>
          <select id="readingListLanguageSelect">
            <option value="ja" selected>üáØüáµ</option>
            <option value="en">üá∫üá∏</option>
            <option value="zh-TW">üáπüáº</option>
          </select>
          <button name="languageDetectButton" onclick="toggleAutoLangaugeDetect(this)">üò¥</button>
        </span>
        <button class="phone-button" onclick="toggleWidgetArea('ReadingListInputArea', 'toggleReadingListInputArea-button', 'ReadingList Ipt')">‚õî</button>
      </td>
      <td>
        <textarea id="readingListInput" rows="2" cols="84"></textarea>
      </td>
      <td>
        <button type="button" name="translateButton"
          onclick="speechTranslate(this.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelector('select').value, this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === 'ü§î', translationLanguageSelect)">üî§</button>
        <button onclick="copyTextArea(this)">‚úÇÔ∏è</button>
        <button onclick="clearReadingList(this)">üÜë</button>
        <span class="readButtons">
          <select id="repeatTimeSelect" style="width: 40px;">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="30">30</option>
            <option value="50">50</option>
            <option value="99">99</option>
          </select>
          <button style="font-size: 7px;" onclick="ggSpeakAllInputText(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value, repeatTimeSelect.value)">Güîä</button>
          <button style="font-size: 7px;" onclick="msSpeakAllInputText(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value, repeatTimeSelect.value)">Müîä</button>
        </span>
      </td>
    </tr>
  </table>

  <div class="row-container" style="margin-top:6px; margin-bottom:6px;">
    <table>
      <tr>
        <td style="display: flex;">
          <button id="ggPauseAudio-button" style="width:40px; margin-right:5px;" onclick="ggPauseAudio()">G‚èØ</button>
          <audio id="ggSpeakAudio" src="" controls preload="metadata" style="height:25px;"></audio>
        </td>
        <td style="display: flex;">
          <button id="msPauseAudio-button" style="width:40px; margin-right:5px;" onclick="msPauseAudio()">M‚èØ</button>
          <audio id="msSpeakAudio" src="" controls preload="metadata" style="height:25px;"></audio>
        </td>
      <tr>
    </table>
  </div>

  <div id="jpExpAreaFrame" style="display:none">
    <div id="jpExpArea">
    </div>
  </div>
  <div id="jpExpAreaTest">
  </div>

  <iframe id="jpExpWebBot" style="width:1000px; height:654px; margin-top:5px; margin-bottom:9px; display:none" src="https://ichi.moe/"></iframe>

  <div class="row-container" style="margin-top:5px; margin-bottom:9px;">
    <span class="layout-container">
      <button id="toggleRecognitionInputArea-button" style="margin-right:3px;" onclick="toggleWidgetArea('recognitionInputArea', 'toggleRecognitionInputArea-button', 'Recognition Ipt')">Recognition Ipt üü¢</button>
      <button id="toggleRecordInputArea-button" style="margin-right:3px;" onclick="toggleWidgetArea('recordInputArea', 'toggleRecordInputArea-button', 'Record Ipt')">Record Ipt ‚ùå</button>

      <button id="toggleTranslationInputArea-button" style="margin-right:3px;" onclick="toggleWidgetArea('translationInputArea', 'toggleTranslationInputArea-button', 'Translation Ipt')">Translation Ipt ‚ùå</button>
      <button id="toggleJpExpInputArea-button" style="margin-right:3px;" onclick="toggleWidgetArea('jpExpInputArea', 'toggleJpExpInputArea-button', 'JpExp Ipt')">JpExp Ipt ‚ùå</button>
      <button id="toggleReadingListInputArea-button" style="margin-right:3px;" onclick="toggleWidgetArea('readingListInputArea', 'toggleReadingListInputArea-button', 'ReadingList Ipt')">ReadingList Ipt üü¢</button>


      <button id="toggleJpExpArea-button" style="margin-right:3px;" onclick="toggleWidgetArea('jpExpAreaFrame', 'toggleJpExpArea-button', 'JpExp Text')">JpExp Text ‚ùå</button>
      <button id="toggleJpExpWebTop-button" style="margin-right:3px;" onclick="toggleWidgetArea('jpExpWebTop', 'toggleJpExpWebTop-button', 'JpExpTop Web')">JpExpTop Web ‚ùå</button>
      <button id="toggleJpExpWebBot-button" style="margin-right:3px;" onclick="toggleWidgetArea('jpExpWebBot', 'toggleJpExpWebBot-button', 'JpExpBot Web')">JpExpBot Web ‚ùå</button>

      <button id="toggleApiKeyEditor-button" style="margin-right:3px;" onclick="toggleWidgetArea('apiKeyEditor', 'toggleApiKeyEditor-button', 'ApiKey Editor')">ApiKey Editor ‚ùå‚Äç</button>
      <button id="toggleLayoutEditor-button" style="margin-right:3px;" onclick="toggleWidgetArea('layoutEditor', 'toggleLayoutEditor-button', 'Layout Editor')">Layout Editor ‚ùå</button>
    </span>
  </div>

  <div id="apiKeyEditor" style="display:none; margin-bottom:9px;">
    <div class="row-container-left">
      <span style="width: 175px;"> Google Script API-KEY: </span>
      <input type="password" id="apiKeyInput-0" size="50" oninput="updateApiKey(0)"> &nbsp;
      <button ontouchstart="showApiKey(0, this)" ontouchend="hideApiKey(0, this)"
          onmousedown="showApiKey(0, this)" onmouseup="hideApiKey(0, this)">üëÅÔ∏è</button> &nbsp;
      <button onclick="copyApiKey(0, this)">‚úÇÔ∏è</button> &nbsp;
    </div>
    <div class="row-container-left">
      <span style="width: 175px;"> GCP API-KEY: </span>
      <input type="password" id="apiKeyInput-1" size="50" oninput="updateApiKey(1)"> &nbsp;
      <button ontouchstart="showApiKey(1, this)" ontouchend="hideApiKey(1, this)"
          onmousedown="showApiKey(1, this)" onmouseup="hideApiKey(1, this)">üëÅÔ∏è</button> &nbsp;
      <button onclick="copyApiKey(1, this)">‚úÇÔ∏è</button> &nbsp;
    </div>
    <div class="row-container-left">
      <span style="width: 175px;"> Azure TTS Key: </span>
      <input type="password" id="apiKeyInput-2" size="50" oninput="updateApiKey(2)"> &nbsp;
      <button ontouchstart="showApiKey(2, this)" ontouchend="hideApiKey(2, this)"
          onmousedown="showApiKey(2, this)" onmouseup="hideApiKey(2, this)">üëÅÔ∏è</button> &nbsp;
      <button onclick="copyApiKey(2, this)">‚úÇÔ∏è</button> &nbsp;
    </div>
    <div class="row-container-left">
      <span style="width: 175px;"> Azure Translate Key: </span>
      <input type="password" id="apiKeyInput-3" size="50" oninput="updateApiKey(3)"> &nbsp;
      <button ontouchstart="showApiKey(3, this)" ontouchend="hideApiKey(3, this)"
          onmousedown="showApiKey(3, this)" onmouseup="hideApiKey(3, this)">üëÅÔ∏è</button> &nbsp;
      <button onclick="copyApiKey(3, this)">‚úÇÔ∏è</button> &nbsp;
    </div>
  </div>

  <table>
    <tr>
      <td> Language To Recognize: </td>
      <td> <select id="languageSelect-0" onchange="updateLanguage(0)">
        <option value="en">English Ëã±Ë™û English</option>
        <option value="ja" selected>Japanese Êó•Êú¨Ë™û Êó•Êú¨Ë™û</option>
        <option value="zh-CN">Simplified Chinese ‰∏≠ÂõΩË™û Ê±âËØ≠</option>
        <option value="zh-TW">Traditional Chinese Âè∞ÊπæË™û Êº¢Ë™û</option>
        <option value="ko">Korean ÈüìÂõΩË™û ÌïúÍµ≠Ïñ¥</option>
        <option value="es">Spanish „Çπ„Éö„Ç§„É≥Ë™û Espa√±ol</option>
        <option value="fr">French „Éï„É©„É≥„ÇπË™û Fran√ßais</option>
        <option value="pt">Portuguese „Éù„É´„Éà„Ç¨„É´Ë™û Portugu√™s</option>
        <option value="it">Italian „Ç§„Çø„É™„Ç¢Ë™û Italiano</option>
        <option value="de">German „Éâ„Ç§„ÉÑË™û Deutsch</option>
        <option value="pl">Polish „Éù„Éº„É©„É≥„ÉâË™û Polski</option>
        <option value="nl">Dutch „Ç™„É©„É≥„ÉÄË™û Nederlands</option>
        <option value="ru">Russian „É≠„Ç∑„Ç¢Ë™û –†—É—Å—Å–∫–∏–π</option>
        <option value="uk">Ukrainian „Ç¶„ÇØ„É©„Ç§„ÉäË™û —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
      </select> </td>
      <td> Translation Counts: </td>
      <td> <select id="translationSelect" onchange="toggleTranslationCounts()">
        <option value="0">No Translation</option>
        <option value="1">One Translation</option>
        <option value="2" selected>Two Translations</option>
      </select></td>
    <tr>
  </table>

  <table>
    <tr>
      <td> Target Language 1: </td>
      <td> <select id="languageSelect-1" onchange="updateLanguage(1)">
        <option value="en" selected>English Ëã±Ë™û English</option>
        <option value="ja">Japanese Êó•Êú¨Ë™û Êó•Êú¨Ë™û</option>
        <option value="zh-CN">Simplified Chinese ‰∏≠ÂõΩË™û Ê±âËØ≠</option>
        <option value="zh-TW">Traditional Chinese Âè∞ÊπæË™û Êº¢Ë™û</option>
        <option value="ko">Korean ÈüìÂõΩË™û ÌïúÍµ≠Ïñ¥</option>
        <option value="es">Spanish „Çπ„Éö„Ç§„É≥Ë™û Espa√±ol</option>
        <option value="fr">French „Éï„É©„É≥„ÇπË™û Fran√ßais</option>
        <option value="pt">Portuguese „Éù„É´„Éà„Ç¨„É´Ë™û Portugu√™s</option>
        <option value="it">Italian „Ç§„Çø„É™„Ç¢Ë™û Italiano</option>
        <option value="de">German „Éâ„Ç§„ÉÑË™û Deutsch</option>
        <option value="pl">Polish „Éù„Éº„É©„É≥„ÉâË™û Polski</option>
        <option value="nl">Dutch „Ç™„É©„É≥„ÉÄË™û Nederlands</option>
        <option value="ru">Russian „É≠„Ç∑„Ç¢Ë™û –†—É—Å—Å–∫–∏–π</option>
        <option value="uk">Ukrainian „Ç¶„ÇØ„É©„Ç§„ÉäË™û —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
      </select> </td>
      <td>Target Language 2:</td>
      <td> <select id="languageSelect-2" onchange="updateLanguage(2)">
        <option value="en">English Ëã±Ë™û English</option>
        <option value="ja">Japanese Êó•Êú¨Ë™û Êó•Êú¨Ë™û</option>
        <option value="zh-CN">Simplified Chinese ‰∏≠ÂõΩË™û Ê±âËØ≠</option>
        <option value="zh-TW" selected>Traditional Chinese Âè∞ÊπæË™û Êº¢Ë™û</option>
        <option value="ko">Korean ÈüìÂõΩË™û ÌïúÍµ≠Ïñ¥</option>
        <option value="es">Spanish „Çπ„Éö„Ç§„É≥Ë™û Espa√±ol</option>
        <option value="fr">French „Éï„É©„É≥„ÇπË™û Fran√ßais</option>
        <option value="pt">Portuguese „Éù„É´„Éà„Ç¨„É´Ë™û Portugu√™s</option>
        <option value="it">Italian „Ç§„Çø„É™„Ç¢Ë™û Italiano</option>
        <option value="de">German „Éâ„Ç§„ÉÑË™û Deutsch</option>
        <option value="pl">Polish „Éù„Éº„É©„É≥„ÉâË™û Polski</option>
        <option value="nl">Dutch „Ç™„É©„É≥„ÉÄË™û Nederlands</option>
        <option value="ru">Russian „É≠„Ç∑„Ç¢Ë™û –†—É—Å—Å–∫–∏–π</option>
        <option value="uk">Ukrainian „Ç¶„ÇØ„É©„Ç§„ÉäË™û —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
      </select> </td>
    <tr>
  </table>

  <table>
    <tr>
      <td> Azure Japanese Voice:
        <select id="azureVoiceSelect-Japanese" onchange="updateAzureVoice(0)">
          <option value="ja-JP-NanamiNeural">Nanami</option>
          <option value="ja-JP-KeitaNeural">Keita</option>
          <option value="ja-JP-AoiNeural">Aoi</option>
          <option value="ja-JP-DaichiNeural">Daichi</option>
          <option value="ja-JP-MayuNeural">Mayu</option>
          <option value="ja-JP-NaokiNeural">Naoki</option>
          <option value="ja-JP-ShioriNeural">Shiori</option>
        </select>
      </td>
      <td> Azure English Voice:
        <select id="azureVoiceSelect-English" onchange="updateAzureVoice(1)">
          <option value="en-US-JennyMultilingualNeural">Jenny Multilingual</option>
          <option value="en-US-JennyNeural">Jenny</option>
          <option value="en-US-GuyNeural">Guy</option>
          <option value="en-US-AriaNeural">Aria</option>
          <option value="en-US-DavisNeural">Davis</option>
          <option value="en-US-AmberNeural">Amber</option>
          <option value="en-US-AnaNeural">Ana</option>
          <option value="en-US-AshleyNeural">Ashley</option>
          <option value="en-US-BrandonNeural">Brandon</option>
          <option value="en-US-ChristopherNeural">Christopher</option>
          <option value="en-US-CoraNeural">Cora</option>
          <option value="en-US-ElizabethNeural">Elizabeth</option>
          <option value="en-US-EricNeural">Eric</option>
          <option value="en-US-JacobNeural">Jacob</option>
          <option value="en-US-JaneNeural">Jane</option>
          <option value="en-US-JasonNeural">Jason</option>
          <option value="en-US-JennyMultilingualV2Neural">Jenny Multilingual V2</option>
          <option value="en-US-MichelleNeural">Michelle</option>
          <option value="en-US-MonicaNeural">Monica</option>
          <option value="en-US-NancyNeural">Nancy</option>
          <option value="en-US-RogerNeural">Roger</option>
          <option value="en-US-RyanMultilingualNeural">Ryan Multilingual</option>
          <option value="en-US-SaraNeural">Sara</option>
          <option value="en-US-SteffanNeural">Steffan</option>
          <option value="en-US-TonyNeural">Tony</option>
          <option value="en-US-AIGenerate1Neural">AIGenerate1</option>
          <option value="en-US-AIGenerate2Neural">AIGenerate2</option>
          <option value="en-US-BlueNeural">Blue</option>
        </select>
      </td>
      <td> Azure Chinese Voice:
        <select id="azureVoiceSelect-Chinese" onchange="updateAzureVoice(2)">
          <option value="zh-TW-HsiaoChenNeural">HsiaoChen</option>
          <option value="zh-TW-YunJheNeural">YunJhe</option>
          <option value="zh-TW-HsiaoYuNeural">HsiaoYu</option>
          <option value="zh-CN-XiaoxiaoNeural">Xiaoxiao</option>
          <option value="zh-CN-YunxiNeural">Yunxi</option>
          <option value="zh-CN-YunjianNeural">Yunjian</option>
          <option value="zh-CN-XiaoyiNeural">Xiaoyi</option>
          <option value="zh-CN-YunyangNeural">Yunyang</option>
          <option value="zh-CN-XiaochenNeural">Xiaochen</option>
          <option value="zh-CN-XiaohanNeural">Xiaohan</option>
          <option value="zh-CN-XiaomengNeural">Xiaomeng</option>
          <option value="zh-CN-XiaomoNeural">Xiaomo</option>
          <option value="zh-CN-XiaoqiuNeural">Xiaoqiu</option>
          <option value="zh-CN-XiaoruiNeural">Xiaorui</option>
          <option value="zh-CN-XiaoshuangNeural">Xiaoshuang</option>
          <option value="zh-CN-XiaoxuanNeural">Xiaoxuan</option>
          <option value="zh-CN-XiaoyanNeural">Xiaoyan</option>
          <option value="zh-CN-XiaoyouNeural">Xiaoyou</option>
          <option value="zh-CN-XiaozhenNeural">Xiaozhen</option>
          <option value="zh-CN-YunfengNeural">Yunfeng</option>
          <option value="zh-CN-YunhaoNeural">Yunhao</option>
          <option value="zh-CN-YunxiaNeural">Yunxia</option>
          <option value="zh-CN-YunyeNeural">Yunye</option>
          <option value="zh-CN-YunzeNeural">Yunze</option>
        </select>
      </td>
    <tr>
  </table>

  <div class="row-container">
  	<button id="defaultConfig-button" onclick="loadConfig(-1)">üÜë</button>
  	<button id="saveConfig1-button" onclick="saveConfig(1)">S1</button>
  	<button id="loadConfig1-button" onclick="loadConfig(1)">L1</button>
  	<button id="saveConfig2-button" onclick="saveConfig(2)">S2</button>
  	<button id="loadConfig2-button" onclick="loadConfig(2)">L2</button>
    <table>
      <tr>
        <td style="display: none;"> Speech Split Interval (ms): </td>
        <td style="display: none;"> <input type="text" id="speechSplitInterval" size="8" oninput="updateSpeechSplitInterval();"> </td>
        <td style="display: none;"> Speech Clear Interval (ms): </td>
        <td style="display: none;"> <input type="text" id="speechClearInterval" size="8" oninput="updateSpeechClearInterval();"> </td>
        <td> <button id="clearText-button" onclick="clearTexts();">Clear Texts</button> </td>
        <td> <button id="defaultText-button" onclick="defaultTexts();">Default Texts</button> </td>
      </tr>
    </table>
  </div>

  <div id="layoutEditor" style="display:none">
    <table style="margin-left: auto; margin-right: auto; margin-top:9px; margin-bottom:9px;">
      <tr>
        <td><span>Page Background Color:</span></td>
        <td><input id=pageColorPicker type="color" oninput="updatePageColor()"></td>
        <td><span id="pageColorValue"></span></td>
        <td><span>Curtain Background Color:</span></td>
        <td><input id=curtainColorPicker type="color" oninput="updateCurtainColor()"></td>
        <td><span id="curtainColorValue"></span></td>
      </tr>
    </table>
    <table>
      <tr>
        <th colspan="3"><span>Speech Text</span></th>
        <th colspan="3"><span>Translation Text 1</span></th>
        <th colspan="3"><span>Translation Text 2</span></th>
      </tr>
      <tr>
        <td><span>Text Color:</span></td>
        <td><input id=textColorPicker-0 type="color" value="#000000" oninput="updateFontColor(0)"></td>
        <td><span id="textColorValue-0"> #000000 </span></td>
        <td><span>Text Color:</span></td>
        <td><input id=textColorPicker-1 type="color" value="#000000" oninput="updateFontColor(1)"></td>
        <td><span id="textColorValue-1"> #000000 </span></td>
        <td><span>Text Color:</span></td>
        <td><input id=textColorPicker-2 type="color" value="#000000" oninput="updateFontColor(2)"></td>
        <td><span id="textColorValue-2"> #000000 </span></td>
      </tr>
      <tr>
        <td><span>Font Size: </span></td>
        <td><input id=textFontSizeSlider-0 type="range" min="0" max="40" step="1" oninput="updateFontSize(0)"></td>
        <td><span id="textFontSizeValue-0"></span>px</td>
        <td><span>Font Size: </span></td>
        <td><input id=textFontSizeSlider-1 type="range" min="0" max="40" step="1" oninput="updateFontSize(1)"></td>
        <td><span id="textFontSizeValue-1"></span>px</td>
        <td><span>Font Size: </span></td>
        <td><input id=textFontSizeSlider-2 type="range" min="0" max="40" step="1" oninput="updateFontSize(2)"></td>
        <td><span id="textFontSizeValue-2"></span>px</td>
      </tr>
      <tr>
        <td><span>Font Weight: </span></td>
        <td><input id="textFontWeightSlider-0" type="range" min="100" max="900" step="100" oninput=" updateFontWeight(0)"></td>
        <td><span id="textFontWeightValue-0"></span></td>
        <td><span>Font Weight: </span></td>
        <td><input id="textFontWeightSlider-1" type="range" min="100" max="900" step="100" oninput=" updateFontWeight(1)"></td>
        <td><span id="textFontWeightValue-1"></span></td>
        <td><span>Font Weight: </span></td>
        <td><input id="textFontWeightSlider-2" type="range" min="100" max="900" step="100" oninput=" updateFontWeight(2)"></td>
        <td><span id="textFontWeightValue-2"></span></td>
      </tr>
      <tr>
        <td><span>Font Type: </span></td>
        <td colspan="2"><select id="textFontSelect-0" onchange="updateFontFamily(0)">
        </select> </td>
        <td><span>Font Type: </span></td>
        <td colspan="2"><select id="textFontSelect-1" onchange="updateFontFamily(1)">
        </select> </td>
        <td><span>Font Type: </span></td>
        <td colspan="2"><select id="textFontSelect-2" onchange="updateFontFamily(2)">
        </select> </td>
      </tr>
      <tr>
        <td><span>Stroke Color (A):</span></td>
        <td><input id=textStrokeColorPicker-0-0 type="color" oninput="updateStrokeColor(0, 0)"></td>
        <td><span id="textStrokeColorValue-0-0"></span></td>
        <td><span>Stroke Color (A):</span></td>
        <td><input id=textStrokeColorPicker-1-0 type="color" oninput="updateStrokeColor(1, 0)"></td>
        <td><span id="textStrokeColorValue-1-0"></span></td>
        <td><span>Stroke Color (A):</span></td>
        <td><input id=textStrokeColorPicker-2-0 type="color" oninput="updateStrokeColor(2, 0)"></td>
        <td><span id="textStrokeColorValue-2-0"></span></td>
      </tr>
      <tr>
        <td><span>Stroke Width (A): </span></td>
        <td><input id="textStrokeWidthSlider-0-0" type="range" min="0" max="0.2" step="0.05" oninput="updateStrokeWidth(0, 0)"></td>
        <td><span id="textStrokeWidthValue-0-0"></span>em</td>
        <td><span>Stroke Width (A): </span></td>
        <td><input id="textStrokeWidthSlider-1-0" type="range" min="0" max="0.2" step="0.05" oninput="updateStrokeWidth(1, 0)"></td>
        <td><span id="textStrokeWidthValue-1-0"></span>em</td>
        <td><span>Stroke Width (A): </span></td>
        <td><input id="textStrokeWidthSlider-2-0" type="range" min="0" max="0.2" step="0.05" oninput="updateStrokeWidth(2, 0)"></td>
        <td><span id="textStrokeWidthValue-2-0"></span>em</td>
      </tr>
      <tr>
        <td><span>Stroke Color (B):</span></td>
        <td><input id=textStrokeColorPicker-0-1 type="color" oninput="updateStrokeColor(0, 1)"></td>
        <td><span id="textStrokeColorValue-0-1"></span></td>
        <td><span>Stroke Color (B):</span></td>
        <td><input id=textStrokeColorPicker-1-1 type="color" oninput="updateStrokeColor(1, 1)"></td>
        <td><span id="textStrokeColorValue-1-1"></span></td>
        <td><span>Stroke Color (B):</span></td>
        <td><input id=textStrokeColorPicker-2-1 type="color" oninput="updateStrokeColor(2, 1)"></td>
        <td><span id="textStrokeColorValue-2-1"></span></td>
      </tr>
      <tr>
        <td><span>Stroke Width (B): </span></td>
        <td><input id="textStrokeWidthSlider-0-1" type="range" min="0" max="0.8" step="0.05" oninput="updateStrokeWidth(0, 1)"></td>
        <td><span id="textStrokeWidthValue-0-1"></span>em</td>
        <td><span>Stroke Width (B): </span></td>
        <td><input id="textStrokeWidthSlider-1-1" type="range" min="0" max="0.8" step="0.05" oninput="updateStrokeWidth(1, 1)"></td>
        <td><span id="textStrokeWidthValue-1-1"></span>em</td>
        <td><span>Stroke Width (B): </span></td>
        <td><input id="textStrokeWidthSlider-2-1" type="range" min="0" max="0.8" step="0.05" oninput="updateStrokeWidth(2, 1)"></td>
        <td><span id="textStrokeWidthValue-2-1"></span>em</td>
      </tr>
      <tr>
        <td><label for="textShadowColorPicker-0">Shadow Color:</label></td>
        <td><input id=textShadowColorPicker-0 type="color" value="#dafffb" oninput="updateTextShadow(0)"></td>
        <td><span id="textShadowColorValue-0"> #dafffb </span></td>
        <td><label for="textShadowColorPicker-1">Shadow Color:</label></td>
        <td><input id=textShadowColorPicker-1 type="color" value="#dafffb" oninput="updateTextShadow(1)"></td>
        <td><span id="textShadowColorValue-1"> #dafffb </span></td>
        <td><label for="textShadowColorPicker-2">Shadow Color:</label></td>
        <td><input id=textShadowColorPicker-2 type="color" value="#dafffb" oninput="updateTextShadow(2)"></td>
        <td><span id="textShadowColorValue-2"> #dafffb </span></td>
      </tr>
      <tr>
        <td><span>Shadow Blur Radius: </span></td>
        <td><input id="textShadowBlurRadiusSlider-0" type="range" min="0" max="1" step="0.05" oninput="updateTextShadow(0)"></td>
        <td><span id="textShadowBlurRadiusValue-0"></span>em</td>
        <td><span>Shadow Blur Radius: </span></td>
        <td><input id="textShadowBlurRadiusSlider-1" type="range" min="0" max="1" step="0.05" oninput="updateTextShadow(1)"></td>
        <td><span id="textShadowBlurRadiusValue-1"></span>em</td>
        <td><span>Shadow Blur Radius: </span></td>
        <td><input id="textShadowBlurRadiusSlider-2" type="range" min="0" max="1" step="0.05" oninput="updateTextShadow(2)"></td>
        <td><span id="textShadowBlurRadiusValue-2"></span>em</td>
      </tr>
      <tr>
        <td><span>Margin Bottom: </span></td>
        <td><input id="textMarginSlider-0" type="range" min="0" max="100" step="1" oninput="updateTextMargin(0)"></td>
        <td><span id="textMarginValue-0"></span>px</td>
        <td><span>Margin Bottom: </span></td>
        <td><input id="textMarginSlider-1" type="range" min="0" max="100" step="1" oninput="updateTextMargin(1)"></td>
        <td><span id="textMarginValue-1"></span>px</td>
        <td><span>Margin Bottom: </span></td>
        <td><input id="textMarginSlider-2" type="range" min="0" max="100" step="1" oninput="updateTextMargin(2)"></td>
        <td><span id="textMarginValue-2"></span>px</td>
      </tr>
    </table>
  </div>

  <ul id="speechTextList"></ul>
  <span id="speechTextListTotalCount"></span>
  <span id="speechTextListCurrentID"></span>
  <ul id="readingList"></ul>
  <span id="readingListTotalCount"></span>
  <br>

  <div class="row-container">
    <ruby> Êó•Êú¨Ë™û<rt>„Å´„Åª„Çì„Åî</rt> &nbsp; </ruby>
    <ruby> ÂãâÂº∑<rt>„Åπ„Çì„Åç„Çá„ÅÜ</rt> „ÅÆ &nbsp; </ruby>
    <ruby> ÁÇ∫<rt>„Åü„ÇÅ</rt> „Å´ &nbsp; </ruby>
    <ruby> Ëá™ÂàÜ<rt>„Åò„Å∂„Çì</rt> „Åß &nbsp; </ruby>
    <ruby> „Åì„ÅÆ„Çµ„Ç§„Éà„Çí<rt>.</rt> &nbsp; </ruby>
    <ruby> ‰Ωú<rt>„Å§„Åè</rt> „Å£„Åü &nbsp; </ruby>
  </div>

  <script>
    var speechTextListTotalCount = 0;
    var speechTextListCurrentID = 0;
    function updateSpeechTextList(text) {
      var speechTextItem = document.createElement('li');
      speechTextItem.textContent = text;
      speechTextList.appendChild(speechTextItem);
      speechTextListTotalCount = speechTextList.childNodes.length;
      document.getElementById('speechTextListTotalCount').innerHTML = `Total Count: ${speechTextListTotalCount}`;
      document.getElementById('speechTextListCurrentID').innerHTML = `Current ID: ${speechTextListCurrentID}`;
    }

    var pageColorPicker = document.getElementById('pageColorPicker');
    var pageColorValue = document.getElementById('pageColorValue');
    var textArea = document.querySelector('.text-area');
    var curtainColorPicker = document.getElementById('curtainColorPicker');
    var curtainColorValue = document.getElementById('curtainColorValue');

    var texts = document.querySelectorAll('[id^="text-"]');
    var textColorPickers = document.querySelectorAll('[id^="textColorPicker-"]');
    var textColorValues = document.querySelectorAll('[id^="textColorValue-"]');
    var textFontSizeSliders = document.querySelectorAll('[id^="textFontSizeSlider-"]');
    var textFontSizeValues =  document.querySelectorAll('[id^="textFontSizeValue-"]');
    var textFontWeightSliders = document.querySelectorAll('[id^="textFontWeightSlider-"]');
    var textFontWeightValues = document.querySelectorAll('[id^="textFontWeightValue-"]');
    var textFontFamilySelects = document.querySelectorAll('[id^="textFontSelect-"]');
    var readingSelects = document.querySelectorAll('[id^="readingSelect"]');

    var textStrokeColorPickers = [];
    for (let i = 0; i < 3; i++) {
      textStrokeColorPickers[i] = [];
      for (let j = 0; j < 2; j++)
        textStrokeColorPickers[i][j] = document.getElementById(`textStrokeColorPicker-${i}-${j}`);
    }
    var textStrokeColorValues = [];
    for (let i = 0; i < 3; i++) {
      textStrokeColorValues[i] = [];
      for (let j = 0; j < 2; j++)
        textStrokeColorValues[i][j] = document.getElementById(`textStrokeColorValue-${i}-${j}`);
    }
    var textStrokeWidthSliders = [];
    for (let i = 0; i < 3; i++) {
      textStrokeWidthSliders[i] = [];
      for (let j = 0; j < 2; j++)
        textStrokeWidthSliders[i][j] = document.getElementById(`textStrokeWidthSlider-${i}-${j}`);
    }
    var textStrokeWidthValues = [];
    for (let i = 0; i < 3; i++) {
      textStrokeWidthValues[i] = [];
      for (let j = 0; j < 2; j++)
        textStrokeWidthValues[i][j] = document.getElementById(`textStrokeWidthValue-${i}-${j}`);
    }
    var textShadowColorPickers = document.querySelectorAll('[id^="textShadowColorPicker-"]');
    var textShadowColorValues = document.querySelectorAll('[id^="textShadowColorValue-"]');
    var textShadowBlurRadiusSliders = document.querySelectorAll('[id^="textShadowBlurRadiusSlider-"]');
    var textShadowBlurRadiusValues = document.querySelectorAll('[id^="textShadowBlurRadiusValue-"]');
    var textMarginSliders = document.querySelectorAll('[id^="textMarginSlider-"]');
    var textMarginValues = document.querySelectorAll('[id^="textMarginValue-"]');
    var textMargins = document.querySelectorAll('[id^="textMargin-"]');
    var apiKeyInputs = document.querySelectorAll('[id^="apiKeyInput-"]');
    var speechSplitInterval = document.getElementById("speechSplitInterval");
    var speechClearInterval = document.getElementById("speechClearInterval");
    var languageSelects = [];
    for (let i = 0; i <= translationCounts; i++) {
      languageSelects.push(document.getElementById(`languageSelect-${i}`));
    }
    var azureVoiceSelects = document.querySelectorAll('[id^="azureVoiceSelect-"]');

    var speechSplitInterval_TimeOut;
    var speechClearInterval_TimeOut;
    var googleScriptKey;
    var gcpApiKey;
    var azureSpeechSubscriptionKey;
    var azureTranslateSubscriptionKey;
  </script>
  <script>
  const myLocalFonts = [
    'Seto',
    'Naikai',
    'Nishikiteki',
    'Iansui',
    'BugMaruGothic',
    'TaipeiSans',
    'WD-XLLubrifont',
    'tkFangSong',
    'LXGWWenKai',
    'LXGWWenKaiMono',
    'SourceHanSans',
    'SourceHanSerif',
    'XiaoheSimplifySans',
    'XiaoheSimplifySerif',
    'AdvocateAncientMono',
    'NotoSansCJK',
    'NotoSansCJKjp',
    'KosugiMaru',
    'JF-openhuninn',
    '851MkPOP',
    'ChenYuluoyan',
    'KsoKagero',
    'KsoKaisho',
    'Mamelon',
    'OzCaramel',
    'Pigmo-00',
  ];
  const generateAllFontAreaCode = () => {
    textFontFamilySelects.forEach(function(element) {
      element.innerHTML = "";
      myLocalFonts.forEach(font => {
        element.innerHTML += `<option value="${font}">${font}</option>`;
      });
    });
  }
  generateAllFontAreaCode();
  </script>

  <script>
    function handleEnterKeyPress(textareaElement) {
      const buttonElement = textareaElement.parentNode.parentNode.querySelector('button[name="translateButton"]');
      textareaElement.addEventListener("keydown", function (event) {
        if (event.keyCode === 13) {
          event.preventDefault();
          buttonElement.click();
        }
      });
    }
    handleEnterKeyPress(recognitionResult);
    handleEnterKeyPress(recordResult);
    handleEnterKeyPress(translateInput);
    handleEnterKeyPress(jpExpInput);

  </script>

  <script>
    var recognizeButton = document.getElementById("recognize-button");
    var recordButton = document.getElementById("record-button");
    var isRecognizing = false;
    var isRecording = false;
    var recognition = new webkitSpeechRecognition();
    var xmlRequest = new XMLHttpRequest();
    var requests = [];
    for (let i = 0; i < translationCounts; i++) {
      requests.push(new XMLHttpRequest());
    }

    function showApiKey(id, button) {
      apiKeyInputs[id].type = "text";
      button.innerHTML = "ü§´";
    }
    function hideApiKey(id, button) {
      apiKeyInputs[id].type = "password";
      button.innerHTML = "üëÅÔ∏è‚Äç";
    }
    function copyApiKey(id, button) {
      var tempInput = document.createElement("input");
      tempInput.type = "text";
      tempInput.value = apiKeyInputs[id].value;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand("copy");
      document.body.removeChild(tempInput);
    }
    function copyTextArea(button) {
      var textarea = button.parentNode.parentNode.querySelector('textarea');
      textarea.select();
      document.execCommand("copy");
    }
    function clearTextArea(button) {
      // nextElementSibling || previousElementSibling
      var textarea = button.parentNode.parentNode.querySelector('textarea');
      textarea.value = "";
    }
    function startRecognition(sourceLanguage="") {
      if (sourceLanguage === "") {
        sourceLanguage = languageSelects[0].value;
      }
      console.log("startRecognition(sourceLanguage):", sourceLanguage);
      recognition.lang = sourceLanguage;
      recognition.interimResults = true;
      recognition.continuous = true;

      var timeStamp = 0;
      recognition.onstart = () => {
        console.log("onstart:", timeStamp);
      }
      recognition.onaudiostart = () => {
        console.log("onaudiostart:", timeStamp);
      }
      recognition.onsoundstart = () => {
        console.log("onsoundstart:", timeStamp);
      }
      recognition.onspeechstart = () => {
        console.log("onspeechstart:", timeStamp);
      }
      recognition.onspeechend = () => {
        console.log("onspeechend:", timeStamp);
      }
      recognition.onsoundend = () => {
        console.log("onsoundend:", timeStamp);
      }
      recognition.onaudioend = () => {
        console.log("onaudioend:", timeStamp);
      }
      recognition.onend = () => {
        console.log("onend:", timeStamp);
        if (isRecognizing) {
          recognition.start();
          timeStamp = timeStamp + 1;
        }
      }
      recognition.onerror = () => {
        console.log("onerror:", timeStamp);
        recognition.stop();
      }
      recognition.onnomatch = () => {
        console.log("onnomatch:", timeStamp);
        recognition.stop();
      }
      stopRecognitionControl = function() {
        console.log(`recognition.stop() after speechSplitInterval(${speechSplitInterval.value}) turns to zero.`);
        recognition.stop();
      }
      recognition.onresult = function(event) {
        console.log("In [recognition.onresult] ", "resultIndex=", event.resultIndex, "resultLength=", event.results.length);
        for (var i = event.resultIndex; i < event.results.length; i++) {
        // { var i = event.results.length - 1;
          var speechText = event.results[i][0].transcript;
          if (speechText.trim() === "") {
            console.log("Empty Speech Text");
          }
          else {
            console.log("Speech Text:", speechText);
            if (event.results[i].isFinal) {
              recognitionResult.value = speechText;
              console.log("japaneseExplanationLocalhost(speechText);", speechText);
              japaneseExplanationLocalhost(speechText);
              if (isRecording) {
                recordResult.value += speechText + ".";
              }
              updateSpeechTextList(speechText);
              // await
              speechTranslate(speechText, sourceLanguage);
            }
            else {
              if (false && speechSplitInterval.value && speechSplitInterval.value !== 0) {
                clearTimeout(speechSplitInterval_TimeOut);
                speechSplitInterval_TimeOut = setTimeout(stopRecognitionControl, speechSplitInterval.value);
              }
              recognitionResult.value = '< ' + speechText + ' >';
            }
          }
        }
      };
      recognition.start();
      timeStamp = timeStamp + 1;
      isRecognizing = true;
      recognizeButton.innerHTML = "‚èπÔ∏è Stop Recognizing";
    }
    function stopRecognition() {
      if (recognition) {
        recognition.stop();
        console.log("recognition.stop()");
      }
      isRecognizing = false;
      recognizeButton.innerHTML = "‚ñ∂Ô∏è Start Recognizing"
    }
    function toggleRecognition(sourceLanguage) {
      if (isRecognizing) {
        stopRecognition();
        if (isRecording) {
          isRecording = false;
          recordButton.innerHTML = "‚ñ∂Ô∏è Start Recording";
        }
      }
      else {
        startRecognition(sourceLanguage);
        if (!isRecording) {
          isRecording = true;
          recordButton.innerHTML = "‚èπÔ∏è Stop Recording";
        }
      }
    }
    function toggleRecord() {
      if (isRecording) {
        isRecording = false;
        recordButton.innerHTML = "‚ñ∂Ô∏è Start Recording";
      }
      else {
        isRecording = true;
        recordButton.innerHTML = "‚èπÔ∏è Stop Recording";
      }
    }
    function toggleTranslationCounts() {
      var translationSelect = document.getElementById("translationSelect");
      translationCounts = translationSelect.value;
      clearTexts(topTranslationCounts);
      defaultTexts();
    }
    var sourceLanguage = "ja";
    var targetLanguage = "en";
    function inputLanguageSwitch() {
      var button = document.getElementById("inputLanguageSwitch-button");
      if (sourceLanguage == "ja") {
        sourceLanguage = "en";
        targetLanguage = "ja";
        button.innerHTML = "ENüî§"
      } else {
        sourceLanguage = "ja";
        targetLanguage = "en";
        button.innerHTML = "JPüî§"
      }
    }
    function toggleAutoLangaugeDetect(button) {
      if (button.innerText === "üò¥") {
        button.innerText = "ü§î";
      }
      else {
        button.innerText = "üò¥";
      }
    }

    var ggAudioList = [];
    var msAudioList = [];
    var ggAudioListTmp = [];
    var msAudioListTmp = [];
    async function ggSpeakUrlGet(text, sourceLanguage) {
      if (window.location.protocol === "file:") {
        var url = "https://translate.google.com/translate_tts?ie=UTF-8&tl=" +
          sourceLanguage +  "&client=tw-ob&q=" + encodeURIComponent(text);
        return url;
      }
      else {
        try {
          const response = await fetch('https://snsmile.site:3000/text-to-speech', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              sourceLanguage: sourceLanguage,
              text: text
            })
          });
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          const audioData = await response.arrayBuffer();
          const audioBlob = new Blob([audioData], { type: 'audio/mpeg' });
          return URL.createObjectURL(audioBlob);
        } catch (error) {
          console.error('Error:', error);
          return null; // or handle the error in a way appropriate for your application
        }
      }
    }
    async function ggSpeak(text, sourceLanguage = "") {
      console.log("ggSpeak text:", text);
      if (text == "") return;
      if (sourceLanguage === "") {
        sourceLanguage = "ja";
      }
      if (ggSpeakAudio) {
        ggSpeakAudio.pause();
      }
      ggSpeakAudio.src = await ggSpeakUrlGet(text, sourceLanguage);
      ggSpeakAudio.play();
      /* if ("speechSynthesis" in window) {
        var speechSynthesis = window.speechSynthesis;
        var utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = sourceLanguage;
        speechSynthesis.speak(utterance);
      }
      */
    }

		const MSTTS_region = "southeastasia";
		const MSTTS_endpoint1 = `https://${MSTTS_region}.api.cognitive.microsoft.com/sts/v1.0/issuetoken`;
		const MSTTS_endpoint2 = `https://${MSTTS_region}.tts.speech.microsoft.com/cognitiveservices/v1`;
    function getMsttsAccessToken() {
      return new Promise((resolve, reject) => {
        var xhr1 = new XMLHttpRequest();
        xhr1.open('POST', MSTTS_endpoint1);
        xhr1.setRequestHeader('Ocp-Apim-Subscription-Key', azureSpeechSubscriptionKey);
        xhr1.send();
        xhr1.onreadystatechange = function() {
          if (xhr1.readyState === 4) {
            if (xhr1.status === 200) {
              var accessToken = xhr1.responseText;
              resolve(accessToken);
            } else {
              reject(new Error(`Failed to get Azure Access Token. Status code: ${xhr1.status}`));
            }
          }
        };
        xhr1.onerror = function() {
          reject(new Error('Request error'));
        };
      });
    }
    async function getMsAudioData(text, sourceLanguage, MSTTS_voiceName, accessToken) {
      return new Promise((resolve, reject) => {
        const xhr2 = new XMLHttpRequest();
        const headers = {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/ssml+xml",
          "X-Microsoft-OutputFormat": "audio-16khz-128kbitrate-mono-mp3"
        };
        xhr2.open('POST', MSTTS_endpoint2);
        for (const [key, value] of Object.entries(headers)) {
          xhr2.setRequestHeader(key, value);
        }
        xhr2.responseType = 'arraybuffer';
        const requestBody = `<speak version='1.0' xml:lang='en-US'><voice name='${MSTTS_voiceName}'>${text}</voice></speak>`;
        xhr2.onload = function() {
          if (xhr2.status >= 200 && xhr2.status < 300) {
            resolve(xhr2.response);
          } else {
            reject(new Error(`Request failed with status ${xhr2.status}`));
          }
        };
        xhr2.onerror = function() {
          reject(new Error('Request error'));
        };
        xhr2.send(requestBody);
      });
    }
    function updateAzureVoice(id, value="") {
      if (value === "") value = azureVoiceSelects[id].value;
      else azureVoiceSelects[id].value = value;
      configs[autoSID].azureVoices[id] = value;
      saveConfigStorage();
    }
    async function msSpeak(text, sourceLanguage = "") {
      console.log("msSpeak-text:", text);
      if (text === "") return;
      var MSTTS_voiceName;
      if (sourceLanguage === "ja") {
        MSTTS_voiceName = azureVoiceSelects[0].value;
      } else if (sourceLanguage === "en") {
        MSTTS_voiceName = azureVoiceSelects[1].value;
      } else if (sourceLanguage === "zh-TW") {
        MSTTS_voiceName = azureVoiceSelects[2].value;
      }
      try {
        const accessToken = await getMsttsAccessToken();
        const audioData = await getMsAudioData(text, sourceLanguage, MSTTS_voiceName, accessToken);
        const audioBlob = new Blob([audioData], { type: 'audio/mpeg' });
        msSpeakAudio.src = URL.createObjectURL(audioBlob);
        msSpeakAudio.play();
      } catch (error) {
        console.error("Error while executing msSpeak:", error);
      }
    }

    function msPauseAudio() {
      if (msSpeakAudio) {
        if (msSpeakAudio.paused) {
          msSpeakAudio.play();
        } else {
          msSpeakAudio.pause();
        }
      }
    }
    function ggPauseAudio() {
      if (ggSpeakAudio) {
        if (ggSpeakAudio.paused) {
          ggSpeakAudio.play();
        } else {
          ggSpeakAudio.pause();
        }
      }
    }

    function clearReadingList() {
      ggAudioList = [];
      msAudioList = [];
      while (readingList.firstChild) {
        readingList.removeChild(readingList.firstChild);
      }
    }
    function chooseAzureVoice(sourceLanguage) {
      if (sourceLanguage === "ja") {
        return azureVoiceSelects[0].value;
      } else if (sourceLanguage === "en") {
        return azureVoiceSelects[1].value;
      } else if (sourceLanguage === "zh-TW") {
        return azureVoiceSelects[2].value;
      }
    }
    async function addToGgReadingList(ggAudioList, lines=1) {
      if (targetLanguages === undefined || targetLanguages.length === 0) {
        await getTargetLanguages();
        console.log("targetLanguages: ", targetLanguages);
      }
      for (let i = 0; i < lines; i++) {
        var url = await ggSpeakUrlGet(texts[i].textContent, targetLanguages[i]);
        ggAudioList.push(url);
      }
      console.log("ggAudioList:", ggAudioList);
    }
    async function addToMsReadingList(msAudioList, lines = 1) {
      if (targetLanguages === undefined || targetLanguages.length === 0) {
        await getTargetLanguages();
      }
      try {
        const accessToken = await getMsttsAccessToken();
        for (let i = 0; i < lines; i++) {
          var MSTTS_voiceName = chooseAzureVoice(targetLanguages[i]);
          const audioData = await getMsAudioData(texts[i].textContent, targetLanguages[i], MSTTS_voiceName, accessToken);
          msAudioList.push(audioData);
        }
        console.log("msAudioList:", msAudioList);
        return msAudioList;
      } catch (error) {
        console.error("Error while adding to MsReadingList:", error);
        throw error;
      }
    }
    async function addToReadingList(ggAudioList, msAudioList, text, sourceLanguage = "", lines=1, isAutoDetect=false, languageSelect=undefined) {
      if (sourceLanguage === "") {
        sourceLanguage = "ja";
      }
      await speechTranslate(text, sourceLanguage, isAutoDetect, languageSelect);
      await addToGgReadingList(ggAudioList, lines);
      await addToMsReadingList(msAudioList, lines);
      for (let i = 0; i < lines; i++) {
        var readingListItem = document.createElement('li');
        readingListItem.textContent = texts[i].textContent + ` - [${targetLanguages[i]}]`;
        readingList.appendChild(readingListItem);
      }
    }
    async function ggSpeakReadingList(ggAudioList, repeatTime) {
      if (ggSpeakAudio) {
        ggSpeakAudio.pause();
      }
      var totalRepeatTime = ggAudioList.length * Math.abs(repeatTime);
      var currentAudioIndex = 0;
      console.log("ggAudioList.length:", ggAudioList.length);
      console.log("totalRepeatTime:", totalRepeatTime);
      ggSpeakAudio.addEventListener('ended', function() {
        currentAudioIndex++;
        if (currentAudioIndex < totalRepeatTime) {
          ggSpeakAudio.pause();
          var i = currentAudioIndex % ggAudioList.length;
          ggSpeakAudio.src = ggAudioList[i];
          ggSpeakAudio.play();
        }
      });
      ggSpeakAudio.src = ggAudioList[currentAudioIndex];
      ggSpeakAudio.play();
    }
    async function msSpeakReadingList(msAudioList, repeatTime) {
      if (msSpeakAudio) {
        msSpeakAudio.pause();
      }
      var totalRepeatTime = msAudioList.length * Math.abs(repeatTime);
      console.log("msAudioList.length:", msAudioList.length);
      console.log("totalRepeatTime:", totalRepeatTime);
      function msListPlayAudio(currentAudioIndex) {
        if (currentAudioIndex >= totalRepeatTime) return;
        var i = currentAudioIndex % msAudioList.length;
        var audioDataCopy = msAudioList[i].slice();
        const audioData = msAudioList[i];
        const audioBlob = new Blob([audioData], { type: 'audio/mpeg' });
        msSpeakAudio.src = URL.createObjectURL(audioBlob);
        msSpeakAudio.onended = function() {
          msAudioList[i] = audioDataCopy;
          msListPlayAudio(currentAudioIndex + 1);
        };
        msSpeakAudio.play();
      }
      msListPlayAudio(0);
    }

    async function ggDetectLanguage(text) {
      const url = `https://translation.googleapis.com/language/translate/v2/detect?key=${gcpApiKey}`;
      const data = {
        q: text
      };
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });
        const responseData = await response.json();
        var detectedLanguage = responseData.data.detections[0][0].language;
        var confidence = responseData.data.detections[0][0].confidence;
        console.log(`Detected Language: ${detectedLanguage} (Confidence: ${confidence})`);
        if (detectedLanguage === "zh-CN") {
          detectedLanguage = "zh-TW";
        }
        if ((detectedLanguage === "zh-CN" || detectedLanguage === "zh-TW") && confidence < 0.9) {
          detectedLanguage = "ja";
        }
        return detectedLanguage;
      } catch (error) {
        console.error('ggDetectLanguage Error:', error);
      }
    }

    async function autoDetectTranslate(text, languageSelect=undefined) {
      var sourceLanguage = await ggDetectLanguage(text);
      if (languageSelect !== undefined) {
        languageSelect.value = sourceLanguage;
      }
      return sourceLanguage;
    }

    function ggTranslate(text) {
      var text = $("#inputArea").val();
      if (googleScriptKey != null && googleScriptKey != "") {
        query = `https://script.google.com/macros/s/${googleScriptKey}/exec?`
          + `text=${text}`
          + `&source=${sourceLanguage}`
          + `&target=${targetLanguage}`;
        xmlRequest.open('GET', query, true);
        xmlRequest.onreadystatechange = function(){
          if (xmlRequest.readyState === 4 && xmlRequest.status === 200){
            return xmlRequest.responseText;
          }
        }
        xmlRequest.send(null);
      }
    }

    var targetLanguages;
    async function getTargetLanguages(sourceLanguage="") {
      if (sourceLanguage === "") {
        sourceLanguage = await ggDetectLanguage(texts[0].textContent);
      }
      targetLanguages = [];
      targetLanguages.push(sourceLanguage);
      for (let i = 0; i <= translationCounts; i++) {
        if (languageSelects[i].value != sourceLanguage) {
          targetLanguages.push(languageSelects[i].value);
        }
        readingSelects[i].value = targetLanguages[i];
      }
    }

    function jpExpWebUpdate(speechText) {
      if (jpExpWebTop.style.display === 'block') {
        var noSpaceSpeechText = speechText.replace(/\s+/g, "");
        var encodedSpeechText = encodeURIComponent(noSpaceSpeechText);
        var ichimoe_url = "https://ichi.moe/cl/qr/?q=" + encodedSpeechText;
        jpExpWebTop.src = ichimoe_url;
      }
      if (jpExpWebBot.style.display === 'block') {
        var noSpaceSpeechText = speechText.replace(/\s+/g, "");
        var encodedSpeechText = encodeURIComponent(noSpaceSpeechText);
        var ichimoe_url = "https://ichi.moe/cl/qr/?q=" + encodedSpeechText;
        jpExpWebBot.src = ichimoe_url;
      }
    }
    async function speechTranslate(speechText, sourceLanguage="", isAutoDetect=false, languageSelect=undefined) {
      updateText(0, speechText);
      if (sourceLanguage === "" || isAutoDetect) {
        sourceLanguage = await autoDetectTranslate(speechText, languageSelect);
      }
      if (sourceLanguage === "ja") {
        jpExpWebUpdate(speechText);
      }
      await getTargetLanguages(sourceLanguage);

      console.log("sourceLanguage:", sourceLanguage);
      console.log("targetLanguages:", targetLanguages);
      console.log("readingSelects:", readingSelects);
      if (googleScriptKey != null && googleScriptKey != "") {
        const requestsPromises = [];
        for (let i = 1; i < targetLanguages.length; i++) {
          const targetLanguage = targetLanguages[i];
          const promise = new Promise((resolve, reject) => {
            const query = `https://script.google.com/macros/s/${googleScriptKey}/exec?`
              + `text=${speechText}`
              + `&source=${sourceLanguage}`
              + `&target=${targetLanguage}`;
            const xhr = new XMLHttpRequest();
            xhr.open('GET', query, true);
            xhr.onreadystatechange = function () {
              if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                  updateText(i, xhr.responseText);
                  if (targetLanguage === "ja") {
                    jpExpWebUpdate(xhr.responseText);
                  }
                  resolve();
                } else {
                  reject(new Error('Failed to finish speechTranslate()'));
                }
              }
            };
            xhr.send();
          });
          requestsPromises.push(promise);
        }
        return Promise.all(requestsPromises);
      } else {
        return Promise.resolve();
      }
    }
    function toggleWidgetArea(widgetName, buttonName, text) {
      var widget = document.getElementById(widgetName);
      var button = document.getElementById(buttonName);
      button.innerHTML = button.innerHTML === `${text} üü¢` ? `${text} ‚ùå` : `${text} üü¢`;
      widget.style.display = button.innerHTML === `${text} üü¢` ? 'block' : 'none';
      // compact = inline || block
    }
    function saveConfigStorage() {
      var configJSON = JSON.stringify(configs);
      localStorage.setItem('snowyTranslatorConfig', configJSON);
    }
    function loadConfigStorage() {
      if (localStorage.getItem('snowyTranslatorConfig')) {
        configs = JSON.parse(localStorage.getItem('snowyTranslatorConfig'));
      }
    }
    function updatePageColor(color = "") {
      if (color === "") color = pageColorPicker.value;
      else pageColorPicker.value = color;
      pageColorValue.innerHTML = color;
      document.body.style.backgroundColor = color;
      configs[autoSID].pageColor = color;
      saveConfigStorage();
    }
    function updateCurtainColor(color = "") {
      if (color === "") color = curtainColorPicker.value;
      else curtainColorPicker.value = color;
      curtainColorValue.innerHTML = color;
      textArea.style.background = color;
      configs[autoSID].curtainColor = color;
      saveConfigStorage();
    }
    function updateText(id, speechText) {
      texts[id].textContent = speechText;
      texts[id].setAttribute('stroke-data', texts[id].textContent);
      configs[autoSID].texts[id] = speechText;
      saveConfigStorage();
    }
    function clearTexts(topRow=-1) {
      if (topRow === -1) {
        topRow = translationCounts;
      }
      for (let i = 0; i <= topRow; i++) {
        updateText(i, "");
      }
    }
    function defaultTexts(topRow=-1) {
      if (topRow === -1) {
        topRow = translationCounts;
      }
      for (let i = 0; i <= topRow; i++) {
        updateText(i, defaultConfig.texts[i]);
      }
    }
    function updateFontColor(id, color="") {
      if (color === "") color = textColorPickers[id].value;
      else textColorPickers[id].value = color;
      textColorValues[id].innerHTML = color;
      texts[id].style.color = color;
      configs[autoSID].textFontColors[id] = color;
      saveConfigStorage();
    }
    function updateFontSize(id, value="") {
      if (value === "") value = textFontSizeSliders[id].value;
      else textFontSizeSliders[id].value = value;
      textFontSizeValues[id].innerHTML = value;
      texts[id].style.fontSize = value + 'px';
      configs[autoSID].textFontSizes[id] = value;
      saveConfigStorage();
    }
    function updateFontWeight(id, value="") {
      if (value === "") value = textFontWeightSliders[id].value;
      else textFontWeightSliders[id].value = value;
      textFontWeightValues[id].innerHTML = value;
      texts[id].style.fontWeight = value;
      configs[autoSID].textFontWeights[id] = value;
      saveConfigStorage();
    }
    function updateFontFamily(id, value="") {
      if (value === "") value = textFontFamilySelects[id].value;
      else {
        textFontFamilySelects[id].value = value;
      }
      texts[id].style.fontFamily = value;
      configs[autoSID].textFontFamilies[id] = value;
      saveConfigStorage();
    }
    function updateStrokeColor(id, layer, color="") {
      if (color === "") color = textStrokeColorPickers[id][layer].value;
      else textStrokeColorPickers[id][layer].value = color;
      textStrokeColorValues[id][layer].innerHTML = color;
      texts[id].style.setProperty(`--stroke-color-layer-${layer}`, color);
      configs[autoSID].textStrokeColors[id][layer] = color;
      saveConfigStorage();
    }
    function updateStrokeWidth(id, layer, value="") {
      if (value === "") value = textStrokeWidthSliders[id][layer].value;
      else textStrokeWidthSliders[id][layer].value = value;
      textStrokeWidthValues[id][layer].innerHTML = value;
      texts[id].style.setProperty(`--stroke-width-layer-${layer}`, value + "em");
      configs[autoSID].textStrokeWidths[id][layer] = value;
      saveConfigStorage();
    }
    function updateTextShadow(id, radius="", color="") {
      if (radius === "") radius = textShadowBlurRadiusSliders[id].value;
      else textShadowBlurRadiusSliders[id].value = radius;
      if (color === "") color = textShadowColorPickers[id].value;
      else textShadowColorPickers[id].value = color;
      textShadowBlurRadiusValues[id].innerHTML = radius;
      textShadowColorValues[id].innerHTML = color;
      texts[id].style.textShadow = `0 0 ${radius}em ${color}`;
      configs[autoSID].textShadowBlurRadius[id] = radius;
      configs[autoSID].textShadowColors[id] = color;
      saveConfigStorage();
    }
    function updateTextMargin(id, value="") {
      if (value === "") value = textMarginSliders[id].value;
      else textMarginSliders[id].value = value;
      textMarginValues[id].innerHTML = value;
      textMargins[id].style.marginTop = value + "px";
      configs[autoSID].textMargins[id] = value;
      saveConfigStorage();
    }
    function updateApiKey(id, value="") {
      if (value === "") value = apiKeyInputs[id].value;
      else apiKeyInputs[id].value = value;
      configs[autoSID].apiKeys[id] = value;
      if (id === 0) {
        googleScriptKey = value;
      }
      else if (id === 1) {
        gcpApiKey = value;
      }
      else if (id === 2) {
        azureSpeechSubscriptionKey = value;
      }
      else if (id === 3) {
        azureTranslateSubscriptionKey = value;
      }
      saveConfigStorage();
    }
    function updateSpeechSplitInterval(value=-1) {
      if (value === -1) value = speechSplitInterval.value;
      else speechSplitInterval.value = value;
      configs[autoSID].speechSplitInterval = value;
      saveConfigStorage();
    }
    function updateSpeechClearInterval(value=-1) {
      if (value === -1) value = speechClearInterval.value;
      else speechClearInterval.value = value;
      configs[autoSID].speechClearInterval = value;
      saveConfigStorage();
    }
    function updateLanguage(id, value="") {
      if (value === "") value = languageSelects[id].value;
      else languageSelects[id].value = value;
      configs[autoSID].languages[id] = value;
      saveConfigStorage();
    }
    function saveConfig(configID) {
      console.log(`Save Config (${configID}) ing...`);
      configs[configID].pageColor = pageColorPicker.value;
      configs[configID].curtainColor = curtainColorPicker.value;
      configs[configID].texts = [...texts].map(element => element.innerHTML);
      configs[configID].textFontColors = [...textColorValues].map(element => element.innerHTML);
      configs[configID].textFontSizes = [...textFontSizeValues].map(element => element.innerHTML);
      configs[configID].textFontWeights = [...textFontWeightValues].map(element => element.innerHTML);
      configs[configID].textFontFamilies = [...textFontFamilySelects].map(element => element.value);
      configs[configID].textStrokeColors = textStrokeColorValues.map(elements => [elements[0].innerHTML, elements[1].innerHTML]);
      configs[configID].textStrokeWidths = textStrokeWidthValues.map(elements => [elements[0].innerHTML, elements[1].innerHTML]);
      configs[configID].textShadowBlurRadius = [...textShadowBlurRadiusValues].map(element => element.innerHTML);
      configs[configID].textShadowColors = [...textShadowColorValues].map(element => element.innerHTML);
      configs[configID].textMargins = [...textMarginValues].map(element => element.innerHTML);
      configs[configID].apiKeys = [...apiKeyInputs].map(element => element.value);
      configs[configID].speechSplitInterval = speechSplitInterval.value;
      configs[configID].speechClearInterval = speechClearInterval.value;
      configs[configID].languages = [...languageSelects].map(element => element.value);
      configs[configID].azureVoices = [...azureVoiceSelects].map(element => element.value);
      saveConfigStorage();
      console.log(`Save Config (${configID}) Finished.`);
    }
    function loadConfig(configID) {
      loadConfigStorage();
      if (configID === -1) {
        configs[autoSID] = defaultConfig;
        configID = autoSID;
      }
      console.log(`Load Config (${configID}) ing...`);
      updatePageColor(configs[configID].pageColor);
      updateCurtainColor(configs[configID].curtainColor);
      for (let i = 0; i <= translationCounts; i++) {
        updateText(i, configs[configID].texts[i]);
        updateFontColor(i, configs[configID].textFontColors[i]);
        updateFontSize(i, configs[configID].textFontSizes[i]);
        updateFontWeight(i, configs[configID].textFontWeights[i]);
        updateFontFamily(i, configs[configID].textFontFamilies[i]);
        for (let j = 0; j <= 1; j++) {
          updateStrokeColor(i, j, configs[configID].textStrokeColors[i][j]);
          updateStrokeWidth(i, j, configs[configID].textStrokeWidths[i][j]);
        }
        updateTextShadow(i, configs[configID].textShadowBlurRadius[i], configs[configID].textShadowColors[i]);
        updateTextMargin(i, configs[configID].textMargins[i]);
        updateSpeechSplitInterval(configs[configID].speechSplitInterval);
        updateSpeechClearInterval(configs[configID].speechClearInterval);
        updateLanguage(i, configs[configID].languages[i]);
        updateAzureVoice(i, configs[configID].azureVoices[i]);
      }
      for (let i = 0; i < apiKeyInputs.length; i++) {
        updateApiKey(i, configs[configID].apiKeys[i]);
      }
      console.log(`Load Config (${configID}) Finsihed.`);
    }
    function updateConfig(configID, key, value) {
      configs[configID][key] = value;
      saveConfig(configID);
    }
    function formatJpExp(jpExp) {
      var elements = jpExp.split('<br>');
      var jpExpAreaLength = document.getElementById("jpExpArea").offsetWidth;
      var jpExpAreaTest = $('#jpExpAreaTest');
      var lineLength = 0;
      var html = "";
      for (let i = 0; i < elements.length; i++) {
        var line = elements[i];
        jpExpAreaTest.html(line);
        sentenceLength = jpExpAreaTest.width();
        if (sentenceLength > jpExpAreaLength) {
          if (i > 0) {
            html += "<br>";
          }
          html += line;
          if (i < elements.length - 1) {
            html += "<br>";
          }
        } else {
          if (lineLength + sentenceLength > jpExpAreaLength) {
            html += "<br>";
            lineLength = 0;
          }
          lineLength += sentenceLength;
          html += line;
        }
      }
      return(html);
    }
    async function ScrapeJpExp(text) {
      var jpExp = "";
      try {
        const url = 'https://ichi.moe/cl/qr/?q=' + encodeURIComponent(text);
        const response = await fetch(url);
        const html = await response.text();
        const parser = new DOMParser();
        const soup = parser.parseFromString(html, 'text/html');
        const row_gloss_rows = soup.querySelectorAll('.row.gloss-row:not(.hidden)');
        for (let i = 0; i < row_gloss_rows.length; i++) {
          const row_gloss_row = row_gloss_rows[i];
          const glosses = row_gloss_row.getElementsByClassName('gloss');
          var romaji_str = "";
          jpExp += " „Äê";
          for (let j = 0; j < glosses.length; j++) {
            const gloss = glosses[j];
            const hiragana = gloss.getElementsByTagName('dt')[0];
            if (j > 0) {
              jpExp += " - ";
              romaji_str += " ";
            }
            var word = hiragana.textContent;
            word = word.replace("1. ", "");
            word = word.replace("„Äê", "<rt>");
            word = word.replace("„Äë", "</rt>");
            word = "<ruby> " + word + "</ruby>";
            const romaji = gloss.getElementsByTagName('em')[0].textContent;
            romaji_str += romaji;
            jpExp += word;
          }
          jpExp += ` | ${romaji_str}„Äë<br> `;
        }
        return jpExp;
      }
      catch (error) {
        console.log(`japanese_split: an error occurred: ${error}`);
        return "";
      }
    }
    function japaneseExplanationFile(text = "") {
      if (text === "") {
        text = jpExpInput.value;
      }
      var jpExpPromise = ScrapeJpExp(text);
      var jpExpArea = $('#jpExpArea');
      jpExpPromise.then(function(jpExp) {
        jpExpArea.html(formatJpExp(jpExp));
      })
    }

    function japaneseExplanationLocalhost(text = "") {
      if (text === "") {
        text = $('#jpExpInput').val();
      }
      $.ajax({
        url: '/process',
        type: 'POST',
        data: { jpExpInput: text },
        success: function(response) {
          var jpExpArea = $('#jpExpArea');
          console.log("response.result:", response.result);
          jpExpArea.html(formatJpExp(response.result));
        }
      });
    }

    function japaneseExplanationEntrance() {
      if (window.location.protocol === "file:") {
        console.log("japaneseExplanationFile()");
        japaneseExplanationFile();
      }
      else if (window.location.href.includes("localhost:")) {
        console.log("japaneseExplanationLocalhost()");
        japaneseExplanationLocalhost();
      }
      else {
        console.log("japaneseExplanationWebPage()");
        japaneseExplanationFile();
      }
    }

  </script>

  <script>
    // localStorage.removeItem('snowyTranslatorConfig');
    // localStorage.clear();
    loadConfig(autoSID);
  </script>

  <br>
  <a href="https://wicg.github.io/speech-api" target="_blank">Speech Recognition</a>
  <a href="https://developer.mozilla.org/en-US/docs/Web/HTML" target="_blank">Web HTML Study</a>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="static/Img/favicon/cat-in-leaves-512x512.png">
  <link rel="stylesheet" href="static/font.css">

  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <!-- <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap"  rel="stylesheet"> -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
  <style>
    html, body {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .row-container {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
    }
    .div-row-container {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
    }
    .reading-buttons-container {
      display: flex;
      justify-content: center;
    }
    .row-container-left {
      display: block;
      flex-direction: row;
      align-items: flex-start;
    }
    .layouts-container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      width: 600px;
    }
    .layouts-container button {
      justify-content: center;
      align-items: center;
      width: 110px;
      margin: 0px;
      padding: 2px;
      overflow: hidden;
      font-size: 11px;
    }
    table {
      border-collapse: collapse;
      border: 1px solid black;
    }
    th, td {
      text-align: center;
      vertical-align: middle;
      padding: 4px;
    }
    .input-table {
      table-layout: fixed;
    }
    .input-table button{
      vertical-align: middle;
      height: 28px;
    }
    .input-table select {
      vertical-align: middle;
      height: 28px;
      width: 36px;
      font-family: "Monaco", monospace;
    }
    .text-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      max-width: 95%;
      width: 1000px;
      height: 99px;
      overflow-y: auto;
    }
    rt {
      font-size: 0.65em;
    }
    input[type="range"] {
      height: 10px;
    }
    .svg-stroke-text{
      font-size:50px;
      text-anchor:middle;
      fill:red;
    }
    .svg-stroke-layer-A{
      stroke-width:0.1em;
      stroke:orange;
    }
    .svg-stroke-layer-B{
      stroke-width:0.2em;
      stroke:yellow;
    }
    .svg-stroke-layer-C{
      stroke-width:0.3em;
      stroke:blue;
    }
    .stroke-text {
      position: relative;
      z-index: 0;
    }
    .stroke-text:before {
      content: attr(stroke-data);
      position: absolute;
      left: 0;
      top: 0;
      z-index: -1;
      -webkit-text-stroke: var(--stroke-width-layer-0) var(--stroke-color-layer-0);
    }
    .stroke-text:after {
      content: attr(stroke-data);
      position: absolute;
      left: 0;
      top: 0;
      z-index: -2;
      -webkit-text-stroke: var(--stroke-width-layer-1) var(--stroke-color-layer-1);
    }
    .readButtons button {
      font-size: 9px;
    }
    #jpExpAreaFrame {
      width: 1015px;
      border: 2px solid black;
      max-width: 96%;
      width: 96%;
    }
    #jpExpArea {
			margin-top: 10px;
			margin-bottom: 10px;
      width: 1000px;
      max-width: 96%;
      width: 96%;
    }
    #readingList, #favoriteList {
      width: 800px;
    }
    @media screen and (max-width: 600px) {
      table {
      }
      tr {
        display: block;
        width: 100%;
      }
      th, td {
        display: block;
        margin: 0 auto;
        padding: 2px;
        vertical-align: middle;
      }
      textarea {
        max-width: 96%;
        width: 96%;
      }
      iframe {
        max-width: 100%;
        width: 100%;
        display: block;
        height: auto;
        margin: 0 auto;
      }
      .text-area {
        max-width: 95%;
        width: 95%;
      }
      .button-title {
        display: flex;
        justify-content: space-between;
      }
      .layouts-container {
        width: 100%;
      }
      .layouts-container button {
        height: 32px;
      }
      .row-container-left {
        display: flex;
      }
      .div-row-container {
        display: flex;
        justify-content: center;
        flex-direction: column;
      }
      .phone-row-table tr {
        display: inline-flex;
      }
      .reading-buttons-container,
      .reading-buttons-container select,
      .reading-buttons-container button {
        font-size: 10px;
      }
      .reading-button-container button{
        width:24px;
      }
      #apiKeyEditor input {
        max-width: 96%;
        width: 96%;
      }
      #readingList, #favoriteList {
        max-width: 96%;
        width: 96%;
      }
    }
    @media screen and (min-width: 601px) {
      .phone-button {
        display: none;
      }
    }
  </style>

  <script>
    var runningEnvironment = 0;
    if (window.location.protocol === "file:") {
      console.log("Running as a local file");
      runningEnvironment = 1;
    }
    else if (window.location.href.includes("localhost:")) {
      console.log("Running on localhost");
      runningEnvironment = 2;
    }
    else {
      console.log("Running on a web server");
      runningEnvironment = 3;
    }
  </script>
  <script>
    function printMap(map, str) {
      console.log(`printMap ${str}`)
      map.forEach((value, key) => {
        console.log(`key=${key}, value=${value}`);
      });
    }
    function copyMap(originalMap) {
      return new Map([...originalMap]);
    }
    function saveMap(originalMap) {
      const newArray = [];
      originalMap.forEach((value, key) => {
        if (value) {
          newArray.push(key);
        }
      });
      return newArray;
    }
    function copyConfig(originalConfig) {
      return JSON.parse(JSON.stringify(originalConfig));
    }
    const topTranslationCount = 2;
    var translationCount = 2; // Make it an integer, otherwise it will be a string
    var configCounts = 3;
    var defaultConfig = {
      pageColor: "#fffafa",
      curtainColor: "#9acd32",
      texts: ["きらきらひかる、おそらのほしよ。",
              "Twinkle, twinkle, little star, How I wonder what you are! ",
              "一閃一閃亮晶晶，滿天都是小星星。"],
              // まばたきしては、みんなをみてる。
              // Up above the world so high, Like a diamond in the sky.
              // 掛在天上放光明，好像許多小眼睛。
              // "1234567890 !@#$%^&*() abcdefg ABCDEFG",
      displayedTexts: [],
      textFontColors: ["#000000", "#000000", "#000000"],
      textFontSizes: [20, 17, 14], //px
      textFontWeights: [500, 500, 500],
      textFontFamilies: ["NotoSansCJKjp", "NotoSansCJKjp", "NotoSansCJKjp"],
      textStrokeColors: [['#87ceeb#ffb7c5'], ['#87ceeb#ffb7c5'], ['#87ceeb#ffb7c5']],
      textStrokeWidths: [[0, 0], [0, 0], [0, 0]], //em
      textShadowColors: ["#ffeebb", "#ffeebb", "#ffeebb"],
      textShadowBlurRadius: [0, 0, 0], //em
      textMargins: [5, 5, 5], //px
      apiKeys: ["", "", "", ""],
      speechOverInterval: 3600, //ms
      speechSplitInterval: 2000, //ms
      speechClearInterval: 360000, //ms
      translationCount: 2,
      languages: ['ja', 'en', 'zh-TW'],
      azureVoices: ['ja-JP-AoiNeural', 'en-US-AnaNeural', 'zh-CN-XiaoyouNeural'],
      layoutButtonsClickedList: [],
      historyTextsMaxLength: 20,
      historyTextsCurrentId: 0,
    }
    var defaultTextConfig = {
      historyTexts: [],
      historyTextsLanguages: [],
    }
    defaultConfig.displayedTexts = [...defaultConfig.texts];
    defaultTextConfig.historyTexts.push([...defaultConfig.texts]);
    defaultTextConfig.historyTextsLanguages.push([...defaultConfig.languages]);
    console.log("defaultTextConfig.historyTextsLanguages:", defaultTextConfig.historyTextsLanguages);
    var configs = [
      {}, {}, {},
    ];
    var textConfig = {
      historyTexts: [],
      historyTextsLanguages: [],
      // favoriteHistoryTexts: [],
      // favoriteHistoryTextsLanguages: [],
    };
    var autoSID = 0;
    var favID = 0;
    configs[autoSID] = copyConfig(defaultConfig);
  </script>
  <title>Snowy Speech Translator</title>
</head>
<body>
  <svg width="100%" viewBox="0 0 800 100" display="none">
    <text class="svg-stroke-text svg-stroke-layer-C" name="strokeTitle" x="50%" y="50%">
    </text>
    <text class="svg-stroke-text svg-stroke-layer-B" name="strokeTitle" x="50%" y="50%">
    </text>
    <text class="svg-stroke-text svg-stroke-layer-A" name="strokeTitle" x="50%" y="50%">
    </text>
    <text class="svg-stroke-text" name="strokeTitle" x="50%" y="50%">
    </text>
  </svg>

  <script>
    strokeTitles = document.querySelectorAll('.svg-stroke-text[name="strokeTitle"]');
      strokeTitles.forEach(function(element) {
        element.textContent = "My Speech Translator";
    });
  </script>

  <iframe id="jpExpWebTop" style="width:1050px; height:654px; margin-top:5px; margin-bottom:5px; display:none" src="https://ichi.moe/"></iframe>

  <div class="text-area">
    <div id="textMargin-0"> </div>
    <div class="stroke-text" id="displayedText-0"> </div>
    <div id="textMargin-1"> </div>
    <div class="stroke-text" id="displayedText-1"> </div>
    <div id="textMargin-2"> </div>
    <div class="stroke-text" id="displayedText-2"> </div>
  </div>

  <div class="hiddenTexts" style="display:none">
    <div id="text-0"> </div>
    <div id="text-1"> </div>
    <div id="text-2"> </div>
  </div>
  <script>

    // $(document).ready()
    $(function() {
      $('.text-area').resizable({
        touchAction: 'none',
        handles: 'se',
        resize: function(event, ui) {
        }
      });
    });
  </script>
  <script>
    function adjustTextAreaHeight() {
      textArea.style.height = '99px';
      var maxHeight = textArea.scrollHeight;
      textArea.style.height = (maxHeight - 0) + 'px';
    }
  </script>

  <script>
    async function ggSpeakAllScreenText(repeatTime=1) {
      ggAudioListTmp = [];
      await addToGgReadingList(ggAudioListTmp, 3);
      await ggSpeakReadingList(ggAudioListTmp, repeatTime);
    }
    async function msSpeakAllScreenText(repeatTime=1) {
      msAudioListTmp = [];
      await addToMsReadingList(msAudioListTmp, 3);
      await msSpeakReadingList(msAudioListTmp, repeatTime);
    }
    async function ggSpeakAllInputText(text, languageSelect, isAutoDetect, repeatTime) {
      if (ggAudioList.length === 0) {
        if (text != texts[0].textContent) {
          console.log("ggSpeakAllInputText() text != texts[0].textContent");
          await speechTranslate(text, languageSelect.value, isAutoDetect, languageSelect);
        }
        await addToGgReadingList(ggAudioList, 3);
        console.log("len after addToGgReadingList: ", ggAudioList.length);
      }
      await ggSpeakReadingList(ggAudioList, repeatTime);
    }
    async function msSpeakAllInputText(text, languageSelect, isAutoDetect, repeatTime) {
      if (msAudioList.length === 0) {
        if (text != texts[0].textContent) {
          console.log("msSpeakAllInputText() text != texts[0].textContent");
          await speechTranslate(text, languageSelect.value, isAutoDetect, languageSelect);
        }
        await addToMsReadingList(msAudioList, 3);
      }
      await msSpeakReadingList(msAudioList, repeatTime);
    }
  </script>

  <div class="div-row-container" style="margin-top:5px; margin-bottom:5px;">
    <span style="display:flex; justify-content: center; margin-bottom:3px;">
      <button id="textFuriganaToggleButton" style="font-size: 11px;" title="🔰 To Auto Mark Furigana; 💤 Is Off." onclick="toggleTextFurigana()">🔰</button>
      <button style="margin-left:3px; font-size:11px;" title="Read All Screen Text By Google." onclick="ggSpeakAllScreenText()">G</button>
      <button style="margin-left:3px; font-size:11px;" title="Read All Screen Text By Microsoft." onclick="msSpeakAllScreenText()">M</button>

      <span style="margin-left:7px;"> </span>
      <button style="font-size:10px;" title="Copy text of the source language." onclick="copyText(0)">0</button>
      <button style="font-size:10px;" title="Copy text of the target1 language." onclick="copyText(1)">1</button>
      <button style="font-size:10px;" title="Copy text of the target2 language." onclick="copyText(2)">2</button>

      <span style="margin-left:7px;"> </span>
      <button id="previousText-button" title="Previous Texts" onclick="showHistoryText(configs[autoSID].historyTextsCurrentId-1);">◀️</button>
      <button id="historyTextsIdDisplay" style="font-size:10px;" onclick="addToFavoriteList()"> X/X </button>
      <button id="nextText-button" title="Next Texts" onclick="showHistoryText(configs[autoSID].historyTextsCurrentId+1);">▶️</button>
    </span>
    <span class="reading-buttons-container">
      <span class="reading-button-container" style="margin-left:20px;">
        <select id="readingSelect0">
          <option value="ja" selected>🇯🇵</option>
          <option value="en">🇺🇸</option>
          <option value="zh-TW">🇹🇼</option>
        </select>
        <button title="Read First Language Text By Google." onclick="ggSpeak(texts[0].textContent, this.previousElementSibling.value)">G</button>
        <button title="Read First Language Text By Microsoft." onclick="msSpeak(texts[0].textContent, this.previousElementSibling.previousElementSibling.value)">M</button>
      </span>
      <span class="reading-button-container" style="margin-left:10px;">
        <select id="readingSelect1">
          <option value="ja">🇯🇵</option>
          <option value="en" selected>🇺🇸</option>
          <option value="zh-TW">🇹🇼</option>
        </select>
        <button title="Read Second Language Text By Google." onclick="ggSpeak(texts[1].textContent, this.previousElementSibling.value)">G</button>
        <button title="Read Second Language Text By Microsoft." onclick="msSpeak(texts[1].textContent, this.previousElementSibling.previousElementSibling.value)">M</button>
      </span>
      <span class="reading-button-container" style="margin-left:10px;">
        <select id="readingSelect2">
          <option value="ja">🇯🇵</option>
          <option value="en">🇺🇸</option>
          <option value="zh-TW" selected>🇹🇼</option>
        </select>
        <button title="Read Third Language Text By Google." onclick="ggSpeak(texts[2].textContent, this.previousElementSibling.value)">G</button>
        <button title="Read Third Language Text By Microsoft." onclick="msSpeak(texts[2].textContent, this.previousElementSibling.previousElementSibling.value)">M</button>
      </span>
    </span>
  </div>

  <table class="input-table">
    <tr class="input-table-row" id="recognitionInputArea" style="display:block">
      <td class="button-title">
        <span>
          <button id="recognize-button" onclick="toggleRecognition(this.parentNode.parentNode.querySelector('select').value)" style="width: 148px;">▶️ Start Recognizing</button>
            <select id="recognitionLanguageSelect" onchange="recognizeRestart(this.value)">
              <option value="ja" selected>🇯🇵</option>
              <option value="en">🇺🇸</option>
              <option value="zh-TW">🇹🇼</option>
            </select>
            <button name="languageDetectButton" id="recognizeLangDetectToggleButton" title="🤔 To Auto Detect Text Language; 😴 Is Off." onclick="toggleAutoLangaugeDetect(this)">🤔</button>
            <button id="oneSentenceRecognizeToggleButton" title="① To Recognize A Single Sentence; 〜 Is Nonstop Detection" onclick="toggleOneSentenceRecognize(this)">①</button>
            <button id="updateHistoryTextToggleButton" title="🕳️ To Not Push to History Text; 🎈 Is To Push" onclick="toggleUpdateHistoryText(this)">🕳️</button>
        </span>
        <button class="phone-button" onclick="toggleWidgetArea('recognitionInputArea', document.getElementById('toggleRecognitionInputArea_LayoutButton'))">⛔</button>
      </td>
      <td>
        <textarea id="recognitionResult" rows="2" cols="66"></textarea>
        <div style="display:none">
        <textarea id="recognitionPreviousResult" rows="2" cols="75"></textarea>
        </div>
      </td>
      <td>
        <button name="translateButton" onclick="speechTranslate(this.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelector('select').value, this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === '🤔', recognitionLanguageSelect)">🔤</button>
        <button onclick="copyTextArea(this)">✂️</button>
        <button class="phone-button" onclick="pasteToTextArea(this)">📥</button>
        <button onclick="clearTextArea(this)">🆑</button>
        <span class="readButtons">
          <button onclick="ggSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">G🔊</button>
          <button onclick="msSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">M🔊</button>
        </span>
      </td>
    </tr>

    <tr class="input-table-row" id="recordInputArea" style="display:none">
      <td class="button-title">
        <span>
          <button id="record-button" onclick="toggleRecord()" style="width: 148px;">▶️ Start Recording</button>
          <select id="recordLanguageSelect">
            <option value="ja" selected>🇯🇵</option>
            <option value="en">🇺🇸</option>
            <option value="zh-TW">🇹🇼</option>
          </select>
          <button name="languageDetectButton" id="recordLangDetectToggleButton" title="🤔 To Auto Detect Text Language; 😴 Is Off." onclick="toggleAutoLangaugeDetect(this)">🤔</button>
        </span>
        <button class="phone-button" onclick="toggleWidgetArea('recordInputArea', document.getElementById('toggleRecordInputArea_LayoutButton'))">⛔</button>
      </td>
      <td>
        <textarea id="recordResult" rows="2" cols="75"></textarea>
      </td>
      <td>
        <button name="translateButton" onclick="speechTranslate(this.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelector('select').value, this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === '🤔', recordLanguageSelect)">🔤</button>
        <button onclick="copyTextArea(this)">✂️</button>
        <button onclick="clearTextArea(this)">🆑</button>
        <span class="readButtons">
          <button onclick="ggSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">G🔊</button>
          <button onclick="msSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">M🔊</button>
        </span>
      </td>
    </tr>

    <tr class="input-table-row" id="translationInputArea" style="display:none">
      <td class="button-title">
        <span>
          <button onclick="speechTranslate(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelector('select').value, querySelector('button[name=\'languageDetectButton\']').innerHTML === '🤔', translationLanguageSelect)" style="width: 148px;"> Translate </button>
          <select id="translationLanguageSelect">
            <option value="ja">🇯🇵</option>
            <option value="en" selected>🇺🇸</option>
            <option value="zh-TW">🇹🇼</option>
          </select>
          <button name="languageDetectButton" id="translateLangDetectToggleButton" title="🤔 To Auto Detect Text Language; 😴 Is Off." onclick="toggleAutoLangaugeDetect(this)">🤔</button>
        </span>
        <button class="phone-button" onclick="toggleWidgetArea('translationInputArea', document.getElementById('toggleTranslationInputArea_LayoutButton'))">⛔</button>
      </td>
      <td>
        <textarea id="translateInput" rows="2" cols="75"></textarea>
      </td>
      <td>
        <button type="button" name="translateButton"
          onclick="speechTranslate(this.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelector('select').value, this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === '🤔', translationLanguageSelect)">🔤</button>
        <button onclick="copyTextArea(this)">✂️</button>
        <button onclick="clearTextArea(this)">🆑</button>
        <span class="readButtons">
          <button onclick="ggSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">G🔊</button>
          <button onclick="msSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">M🔊</button>
        </span>
      </td>
    </tr>

    <tr class="input-table-row" id="jpExpInputArea" style="display:none">
      <form action="/process" method="post">
        <td class="button-title">
          <span>
            <button type="button" id="jpExp-button" onclick="japaneseExplanationEntrance()" style="width: 148px;">Japanese Explanation</button>
            <select id="jpExpLanguageSelect">
              <option value="ja" selected>🇯🇵</option>
            </select>
          </span>
          <button type="button" class="phone-button" onclick="toggleWidgetArea('jpExpInputArea', document.getElementById('toggleJpExpInputArea_LayoutButton'))">⛔</button>
        </td>
        <td>
          <textarea id="jpExpInput" rows="2" cols="80"></textarea>
        </td>
        <td>
          <button type="button" name="translateButton" onclick="speechTranslate(this.parentNode.parentNode.querySelector('textarea').value, 'ja')">🔤</button>
          <button type="button" onclick="copyTextArea(this)">✂️</button>
          <button type="button" onclick="clearTextArea(this)">🆑</button>
          <span class="readButtons">
            <button type="button"  onclick="ggSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">G🔊</button>
            <button type="button" onclick="msSpeak(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select').value)">M🔊</button>
          </span>
        </td>
      </form>
    </tr>
  </table>

  <table class="input-table" style="margin-top: 3px; display:block;">
    <tr class="input-table-row" id="readingListInputArea">
      <td class="button-title">
        <span>
          <button type="button" name="translateButton"
            onclick="speechTranslate(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelector('select').value, this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === '🤔', translationLanguageSelect)">訳</button>
          <button onclick="addToReadingList(ggAudioList, msAudioList, 1,  this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === '🤔', readingListLanguageSelect)" > + </button>
          <button onclick="addToReadingList(ggAudioList, msAudioList, 2,  this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === '🤔', readingListLanguageSelect)"> ++ </button>
          <button onclick="addToReadingList(ggAudioList, msAudioList, 3,  this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === '🤔', readingListLanguageSelect)"> +++ </button>
          <select id="readingListLanguageSelect">
            <option value="ja" selected>🇯🇵</option>
            <option value="en">🇺🇸</option>
            <option value="zh-TW">🇹🇼</option>
          </select>
          <button name="languageDetectButton" id="readLangDetectToggleButton" title="🤔 To Auto Detect Text Language; 😴 Is Off." onclick="toggleAutoLangaugeDetect(this)">🤔</button>
        </span>
        <button class="phone-button" onclick="toggleWidgetArea('readingListInputArea', document.getElementById('toggleReadingListInputArea_LayoutButton'))">⛔</button>
      </td>
      <td>
        <textarea id="readingListInput" rows="2" cols="73"></textarea>
      </td>
      <td>
        <button type="button" name="translateButton"
          onclick="speechTranslate(this.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.querySelector('select').value, this.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === '🤔', translationLanguageSelect)">🔤</button>
        <button onclick="copyTextArea(this)">✂️</button>
        <button class="phone-button" onclick="pasteToTextArea(this)">📥</button>
        <button title="Clear The Reading List" onclick="clearReadingList(this)">🆑</button>
        <span class="readButtons">
          <select id="repeatTimeSelect" style="width: 40px;">
            <option value=1>1</option>
            <option value=2 selected>2</option>
            <option value=3>3</option>
            <option value=5>5</option>
            <option value=10>10</option>
            <option value=20>20</option>
            <option value=30>30</option>
            <option value=50>50</option>
            <option value=99>99</option>
          </select>
          <button style="font-size: 7px;" onclick="ggSpeakAllInputText(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select'), this.parentNode.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === '🤔',  repeatTimeSelect.value)">G🔊</button>
          <button style="font-size: 7px;" onclick="msSpeakAllInputText(this.parentNode.parentNode.parentNode.querySelector('textarea').value, this.parentNode.parentNode.parentNode.querySelector('select'), this.parentNode.parentNode.parentNode.querySelector('button[name=\'languageDetectButton\']').innerHTML === '🤔',  repeatTimeSelect.value)">M🔊</button>
        </span>
      </td>
    </tr>
  </table>

  <div class="row-container" style="margin-top:6px; margin-bottom:6px;">
    <table style="border: 0px solid black; padding:10px;">
      <tr>
        <td>
          <button id="ggPauseAudio-button" style="width:42px; margin-right:5px; vertical-align: middle; display:none" onclick="ggPauseAudio()">G⏯</button>
          <span style="vertical-align: middle;">G</span>
          <audio id="ggSpeakAudio" src="static/Audio/あいうえお.mp3" controls style="height:25px; width:315px; vertical-align: middle; padding:1px;"></audio>
        </td>
        <td>
          <button id="msPauseAudio-button" style="width:42px; margin-right:5px; vertical-align: middle; display:none" onclick="msPauseAudio()">M⏯</button>
          <span style="vertical-align: middle;">M</span>
          <audio id="msSpeakAudio" src="static/Audio/abcdefg.mp3" controls style="height:25px; width:315px; vertical-align: middle; padding:1px;"></audio>
        </td>
      <tr>
    </table>
  </div>

  <div id="jpExpAreaFrame" style="display:none; margin-bottom:5px;">
    <div id="jpExpArea">
    </div>
  </div>
  <div id="jpExpAreaTest">
  </div>

  <iframe id="jpExpWebBot" style="width:1000px; height:654px; margin-top:5px; margin-bottom:9px; display:none" src="https://ichi.moe/"></iframe>

  <button id="layoutContainer_LayoutButton" style="margin-bottom:5px;" onclick="toggleWidgetArea('layoutContainer', this)">Layout Container ❌</button>

  <div class="layouts-container" id="layoutContainer" style="margin-bottom:5px; display:none">
    <button id="toggleRecognitionInputArea_LayoutButton" style="margin-right:3px;" onclick="toggleWidgetArea('recognitionInputArea', this)">Recognition 🟢</button>
    <button id="toggleRecordInputArea_LayoutButton" style="margin-right:3px;" onclick="toggleWidgetArea('recordInputArea', this)">Record ❌</button>
    <button id="toggleTranslationInputArea_LayoutButton" style="margin-right:3px;" onclick="toggleWidgetArea('translationInputArea', this)">Translation ❌</button>
    <button id="toggleJpExpInputArea_LayoutButton" style="margin-right:3px;" onclick="toggleWidgetArea('jpExpInputArea', this)">JpExp Input ❌</button>
    <button id="toggleReadingListInputArea_LayoutButton" style="margin-right:3px;" onclick="toggleWidgetArea('readingListInputArea', this)">ReadingList 🟢</button>
    <button id="toggleJpExpArea_LayoutButton" style="margin-right:3px;" onclick="toggleWidgetArea('jpExpAreaFrame', this)">JpExp Text ❌</button>
    <button id="toggleJpExpWebTop_LayoutButton" style="margin-right:3px;" onclick="toggleWidgetArea('jpExpWebTop', this)">JpExp Web (↑) ❌</button>
    <button id="toggleJpExpWebBot_LayoutButton" style="margin-right:3px;" onclick="toggleWidgetArea('jpExpWebBot', this)">JpExp Web (↓) ❌</button>
    <button id="toggleApiKeyEditor_LayoutButton" style="margin-right:3px;" onclick="toggleWidgetArea('apiKeyEditor', this)">ApiKey Editor ❌‍</button>
    <button id="toggleLayoutEditor_LayoutButton" style="margin-right:3px;" onclick="toggleWidgetArea('layoutEditor', this)">Layout Editor ❌</button>
    <button id="toggleLanguageSelects_LayoutButton" style="margin-right:3px;" onclick="toggleWidgetArea('languageSelectsContainer', this)">Lang Selects 🟢</button>
    <button id="toggleVoiceSelects_LayoutButton" style="margin-right:3px;" onclick="toggleWidgetArea('VoiceSelectsContainer', this)">Voice Selects 🟢</button>
    <button id="toggleGlobalValues_LayoutButton" style="margin-right:3px;" onclick="toggleWidgetArea('globalValuesContainer', this)">Global Values 🟢</button>
  </div>

  <script>
    const layoutButtonsMap = new Map();
    const layoutButtonsClickedMap = new Map();
    // window.addEventListener("load", function() {} );
    function initLayoutButtons() {
      var layoutButtons = [];
      // layoutButtons.push(document.getElementById("layoutContainer-button"));
      // layoutButtons.push(...document.getElementById("layoutContainer").querySelectorAll('button'));
      layoutButtons.push(...document.querySelectorAll('[id$="_LayoutButton"]'));
      layoutButtons.forEach(function(button) {
        var buttonText = button.innerHTML.substr(0, button.innerHTML.lastIndexOf(' '));
        layoutButtonsMap.set(buttonText, button);
        layoutButtonsClickedMap.set(buttonText, false);
      });
    };

    function updateLayoutButtonClick(buttonText) {
      var button = layoutButtonsMap.get(buttonText);
      button.click();
    }

    var toggleButtons = document.querySelectorAll('button[id$="ToggleButton"]');
    toggleButtons.forEach(button => {
      layoutButtonsMap.set(button.id, button);
      layoutButtonsClickedMap.set(button.id, false);
      button.addEventListener('click', () => {
        var buttonClicked = !layoutButtonsClickedMap.get(button.id);
        layoutButtonsClickedMap.set(button.id, buttonClicked);
        configs[autoSID].layoutButtonsClickedList = configs[autoSID].layoutButtonsClickedList.filter(item => item !== button.id);
        if (buttonClicked) {
          configs[autoSID].layoutButtonsClickedList.push(button.id);
        }
        saveConfigStorage();
      });
    });
  </script>

  <div id="apiKeyEditor" style="display:none; margin-bottom:5px;">
    <table>
      <tr class="row-container-left">
        <td style="width: 175px;"> Google Script API-KEY: </td>
        <td>
          <input type="password" id="apiKeyInput-0" size="50" oninput="updateApiKey(0)"> &nbsp;
        </td>
        <td>
          <button ontouchstart="showApiKey(0, this)" ontouchend="hideApiKey(0, this)"
              onmousedown="showApiKey(0, this)" onmouseup="hideApiKey(0, this)">👁️</button> &nbsp;
          <button onclick="copyApiKey(0, this)">✂️</button> &nbsp;
        </td>
      </tr>
      <tr class="row-container-left">
        <td style="width: 175px;"> GCP API-KEY: </td>
        <td>
          <input type="password" id="apiKeyInput-1" size="50" oninput="updateApiKey(1)"> &nbsp;
        </td>
        <td>
          <button ontouchstart="showApiKey(1, this)" ontouchend="hideApiKey(1, this)"
              onmousedown="showApiKey(1, this)" onmouseup="hideApiKey(1, this)">👁️</button> &nbsp;
          <button onclick="copyApiKey(1, this)">✂️</button> &nbsp;
        </td>
      </tr>
      <tr class="row-container-left">
        <td style="width: 175px;"> Azure TTS Key: </td>
        <td>
          <input type="password" id="apiKeyInput-2" size="50" oninput="updateApiKey(2)"> &nbsp;
        </td>
        <td>
          <button ontouchstart="showApiKey(2, this)" ontouchend="hideApiKey(2, this)"
              onmousedown="showApiKey(2, this)" onmouseup="hideApiKey(2, this)">👁️</button> &nbsp;
          <button onclick="copyApiKey(2, this)">✂️</button> &nbsp;
        </td>
      </tr>
      <tr class="row-container-left" style="display:none;">
        <td style="width: 175px;"> Azure Translate Key: </td>
        <td>
          <input type="password" id="apiKeyInput-3" size="50" oninput="updateApiKey(3)"> &nbsp;
        </td>
        <td>
          <button ontouchstart="showApiKey(3, this)" ontouchend="hideApiKey(3, this)"
              onmousedown="showApiKey(3, this)" onmouseup="hideApiKey(3, this)">👁️</button> &nbsp;
          <button onclick="copyApiKey(3, this)">✂️</button> &nbsp;
        </td>
      </tr>
      <tr class="row-container-left">
        <td style="width: 175px;"> API Keys Split by ',': </td>
        <td>
          <input type="password" id="apiKeyInput-All" size="50" oninput="updateApiKey(99, this.value)"> &nbsp;
        </td>
      </tr>
    </table>
  </div>

  <table style="border: none">
    <tr class="row-container">
      <td>
      	<button id="defaultConfig-button" onclick="loadConfig(-1)">🆑</button>
      	<button id="saveConfig1-button" onclick="saveConfig(1)">S1</button>
      	<button id="loadConfig1-button" onclick="loadConfig(1)">L1</button>
      	<button id="saveConfig2-button" onclick="saveConfig(2)">S2</button>
      	<button id="loadConfig2-button" onclick="loadConfig(2)">L2</button>
        <span style="margin-left:5px;"> </span>
      	<button id="saveFavoriteConfig-button" onclick="saveConfig(99)">S♡</button>
      	<button id="loadFavoriteConfig-button" onclick="loadConfig(99)">L♡</button>
      </td>
      <td>
        <button id="clearText-button" title="Clear Texts 🆑" onclick="clearTexts();">Clear Texts</button>
        <button id="defaultText-button" title="Default Texts 🛠️" onclick="defaultTexts();">Default Texts</button>
      </td>
    </tr>
  </table>

  <table id="languageSelectsContainer" style="margin-bottom:5px">
    <tr>
      <span style="display: inline-flex; width: 100%;">
        <td> Language To Recognize: </td>
        <td> <select id="languageSelect-0" onchange="updateLanguage(0)">
          <option value="en">English 英語 English</option>
          <option value="ja" selected>Japanese 日本語 日本語</option>
          <option value="zh-CN">Simplified Chinese 中国語 汉语</option>
          <option value="zh-TW">Traditional Chinese 台湾語 漢語</option>
          <option value="ko">Korean 韓国語 한국어</option>
          <option value="es">Spanish スペイン語 Español</option>
          <option value="fr">French フランス語 Français</option>
          <option value="pt">Portuguese ポルトガル語 Português</option>
          <option value="it">Italian イタリア語 Italiano</option>
          <option value="de">German ドイツ語 Deutsch</option>
          <option value="pl">Polish ポーランド語 Polski</option>
          <option value="nl">Dutch オランダ語 Nederlands</option>
          <option value="ru">Russian ロシア語 Русский</option>
          <option value="uk">Ukrainian ウクライナ語 українська</option>
        </select> </td>
      </span>
      <span style="display: inline-flex; width: 100%;">
        <td> Translation Counts: </td>
        <td> <select id="translationCountSelect" onchange="toggleTranslationCount()">
          <option value=0>No Translation</option>
          <option value=1>One Translation</option>
          <option value=2 selected>Two Translations</option>
        </select></td>
      </span>
    </tr>
    <tr>
      <td> Target Language 1: </td>
      <td> <select id="languageSelect-1" onchange="updateLanguage(1)">
        <option value="en" selected>English 英語 English</option>
        <option value="ja">Japanese 日本語 日本語</option>
        <option value="zh-CN">Simplified Chinese 中国語 汉语</option>
        <option value="zh-TW">Traditional Chinese 台湾語 漢語</option>
        <option value="ko">Korean 韓国語 한국어</option>
        <option value="es">Spanish スペイン語 Español</option>
        <option value="fr">French フランス語 Français</option>
        <option value="pt">Portuguese ポルトガル語 Português</option>
        <option value="it">Italian イタリア語 Italiano</option>
        <option value="de">German ドイツ語 Deutsch</option>
        <option value="pl">Polish ポーランド語 Polski</option>
        <option value="nl">Dutch オランダ語 Nederlands</option>
        <option value="ru">Russian ロシア語 Русский</option>
        <option value="uk">Ukrainian ウクライナ語 українська</option>
      </select> </td>
      <td>Target Language 2:</td>
      <td> <select id="languageSelect-2" onchange="updateLanguage(2)">
        <option value="en">English 英語 English</option>
        <option value="ja">Japanese 日本語 日本語</option>
        <option value="zh-CN">Simplified Chinese 中国語 汉语</option>
        <option value="zh-TW" selected>Traditional Chinese 台湾語 漢語</option>
        <option value="ko">Korean 韓国語 한국어</option>
        <option value="es">Spanish スペイン語 Español</option>
        <option value="fr">French フランス語 Français</option>
        <option value="pt">Portuguese ポルトガル語 Português</option>
        <option value="it">Italian イタリア語 Italiano</option>
        <option value="de">German ドイツ語 Deutsch</option>
        <option value="pl">Polish ポーランド語 Polski</option>
        <option value="nl">Dutch オランダ語 Nederlands</option>
        <option value="ru">Russian ロシア語 Русский</option>
        <option value="uk">Ukrainian ウクライナ語 українська</option>
      </select> </td>
    <tr>
  </table>

  <table id="VoiceSelectsContainer" style="margin-bottom:5px">
    <tr>
      <td> Azure Japanese Voice:
        <select id="azureVoiceSelect-Japanese" onchange="updateAzureVoice(0)">
          <option value="ja-JP-NanamiNeural">Nanami</option>
          <option value="ja-JP-KeitaNeural">Keita</option>
          <option value="ja-JP-AoiNeural">Aoi</option>
          <option value="ja-JP-DaichiNeural">Daichi</option>
          <option value="ja-JP-MayuNeural">Mayu</option>
          <option value="ja-JP-NaokiNeural">Naoki</option>
          <option value="ja-JP-ShioriNeural">Shiori</option>
        </select>
      </td>
      <td> Azure English Voice:
        <select id="azureVoiceSelect-English" onchange="updateAzureVoice(1)">
          <option value="en-US-JennyMultilingualNeural">Jenny Multilingual</option>
          <option value="en-US-JennyNeural">Jenny</option>
          <option value="en-US-GuyNeural">Guy</option>
          <option value="en-US-AriaNeural">Aria</option>
          <option value="en-US-DavisNeural">Davis</option>
          <option value="en-US-AmberNeural">Amber</option>
          <option value="en-US-AnaNeural">Ana</option>
          <option value="en-US-AshleyNeural">Ashley</option>
          <option value="en-US-BrandonNeural">Brandon</option>
          <option value="en-US-ChristopherNeural">Christopher</option>
          <option value="en-US-CoraNeural">Cora</option>
          <option value="en-US-ElizabethNeural">Elizabeth</option>
          <option value="en-US-EricNeural">Eric</option>
          <option value="en-US-JacobNeural">Jacob</option>
          <option value="en-US-JaneNeural">Jane</option>
          <option value="en-US-JasonNeural">Jason</option>
          <option value="en-US-JennyMultilingualV2Neural">Jenny Multilingual V2</option>
          <option value="en-US-MichelleNeural">Michelle</option>
          <option value="en-US-MonicaNeural">Monica</option>
          <option value="en-US-NancyNeural">Nancy</option>
          <option value="en-US-RogerNeural">Roger</option>
          <option value="en-US-RyanMultilingualNeural">Ryan Multilingual</option>
          <option value="en-US-SaraNeural">Sara</option>
          <option value="en-US-SteffanNeural">Steffan</option>
          <option value="en-US-TonyNeural">Tony</option>
          <option value="en-US-AIGenerate1Neural">AIGenerate1</option>
          <option value="en-US-AIGenerate2Neural">AIGenerate2</option>
          <option value="en-US-BlueNeural">Blue</option>
        </select>
      </td>
      <td> Azure Chinese Voice:
        <select id="azureVoiceSelect-Chinese" onchange="updateAzureVoice(2)">
          <option value="zh-TW-HsiaoChenNeural">HsiaoChen</option>
          <option value="zh-TW-YunJheNeural">YunJhe</option>
          <option value="zh-TW-HsiaoYuNeural">HsiaoYu</option>
          <option value="zh-CN-XiaoxiaoNeural">Xiaoxiao</option>
          <option value="zh-CN-YunxiNeural">Yunxi</option>
          <option value="zh-CN-YunjianNeural">Yunjian</option>
          <option value="zh-CN-XiaoyiNeural">Xiaoyi</option>
          <option value="zh-CN-YunyangNeural">Yunyang</option>
          <option value="zh-CN-XiaochenNeural">Xiaochen</option>
          <option value="zh-CN-XiaohanNeural">Xiaohan</option>
          <option value="zh-CN-XiaomengNeural">Xiaomeng</option>
          <option value="zh-CN-XiaomoNeural">Xiaomo</option>
          <option value="zh-CN-XiaoqiuNeural">Xiaoqiu</option>
          <option value="zh-CN-XiaoruiNeural">Xiaorui</option>
          <option value="zh-CN-XiaoshuangNeural">Xiaoshuang</option>
          <option value="zh-CN-XiaoxuanNeural">Xiaoxuan</option>
          <option value="zh-CN-XiaoyanNeural">Xiaoyan</option>
          <option value="zh-CN-XiaoyouNeural">Xiaoyou</option>
          <option value="zh-CN-XiaozhenNeural">Xiaozhen</option>
          <option value="zh-CN-YunfengNeural">Yunfeng</option>
          <option value="zh-CN-YunhaoNeural">Yunhao</option>
          <option value="zh-CN-YunxiaNeural">Yunxia</option>
          <option value="zh-CN-YunyeNeural">Yunye</option>
          <option value="zh-CN-YunzeNeural">Yunze</option>
        </select>
      </td>
    <tr>
  </table>

  <table id="globalValuesContainer" style="margin-bottom:5px">
    <tr class="row-container">
      <td style="display: flex;">
        Speech Over Interval (ms):
        <input type="text" id="speechOverInterval" size="8" oninput="updateIntegerValue('speechOverInterval');">
      </td>
      <td style="display: flex;">
         History Texts Max Length:
        <select id="historyTextsMaxLengthSelect" style="width: 40px;" onchange="toggleHistoryTextsMaxLength()">
          <option value=1>1</option>
          <option value=2>2</option>
          <option value=3>3</option>
          <option value=5>5</option>
          <option value=10>10</option>
          <option value=20 selected>20</option>
          <option value=30>30</option>
          <option value=50>50</option>
        </select>
      </td>
      <td style="display: none;">
        Speech Split Interval (ms):
        <input type="text" id="speechSplitInterval" size="8" oninput="updateIntegerValue('speechSplitInterval');">
      </td>
      <td style="display: none;">
        Speech Clear Interval (ms):
        <input type="text" id="speechClearInterval" size="8" oninput="updateIntegerValue('speechClearInterval');">
      </td>
    </tr>
  </table>

  <div id="layoutEditor" style="display:none">
    <table style="margin-left: auto; margin-right: auto; margin-bottom: 3px;">
      <tr>
        <td>
          <span>Page Background Color:</span>
          <input id=pageColorPicker type="color" oninput="updatePageColor()">
          <span id="pageColorValue"></span>
        </td>
        <td>
          <span>Curtain Background Color:</span>
          <input id=curtainColorPicker type="color" oninput="updateCurtainColor()">
          <span id="curtainColorValue"></span>
        </td>
      </tr>
    </table>
    <table>
      <tr>
        <td>
          <table class="phone-row-table">
            <tr>
              <th colspan="3"><span>Speech Text</span></th>
            </tr>
            <tr>
              <td><span>Text Color:</span></td>
              <td><input id=textColorPicker-0 type="color" value="#000000" oninput="updateFontColor(0)"></td>
              <td><span id="textColorValue-0"> #000000 </span></td>
            </tr>
            <tr>
              <td><span>Font Size: </span></td>
              <td><input id=textFontSizeSlider-0 type="range" min="0" max="40" step="1" oninput="updateFontSize(0)"></td>
              <td><span id="textFontSizeValue-0"></span>px</td>
            </tr>
            <tr>
              <td><span>Font Weight: </span></td>
              <td><input id="textFontWeightSlider-0" type="range" min="100" max="900" step="100" oninput=" updateFontWeight(0)"></td>
              <td><span id="textFontWeightValue-0"></span></td>
            </tr>
            <tr>
              <td><span>Font Type: </span></td>
              <td colspan="2"><select id="textFontSelect-0" onchange="updateFontFamily(0)">
              </select> </td>
            </tr>
            <tr>
              <td><span>Stroke Color (A):</span></td>
              <td><input id=textStrokeColorPicker-0-0 type="color" oninput="updateStrokeColor(0, 0)"></td>
              <td><span id="textStrokeColorValue-0-0"></span></td>
            </tr>
            <tr>
              <td><span>Stroke Width (A): </span></td>
              <td><input id="textStrokeWidthSlider-0-0" type="range" min="0" max="0.2" step="0.05" oninput="updateStrokeWidth(0, 0)"></td>
              <td><span id="textStrokeWidthValue-0-0"></span>em</td>
            </tr>
            <tr>
              <td><span>Stroke Color (B):</span></td>
              <td><input id=textStrokeColorPicker-0-1 type="color" oninput="updateStrokeColor(0, 1)"></td>
              <td><span id="textStrokeColorValue-0-1"></span></td>
            </tr>
            <tr>
              <td><span>Stroke Width (B): </span></td>
              <td><input id="textStrokeWidthSlider-0-1" type="range" min="0" max="0.8" step="0.05" oninput="updateStrokeWidth(0, 1)"></td>
              <td><span id="textStrokeWidthValue-0-1"></span>em</td>
            </tr>
            <tr>
              <td><label for="textShadowColorPicker-0">Shadow Color:</label></td>
              <td><input id=textShadowColorPicker-0 type="color" value="#dafffb" oninput="updateTextShadow(0)"></td>
              <td><span id="textShadowColorValue-0"> #dafffb </span></td>
            </tr>
            <tr>
              <td><span>Shadow Blur Radius: </span></td>
              <td><input id="textShadowBlurRadiusSlider-0" type="range" min="0" max="1" step="0.05" oninput="updateTextShadow(0)"></td>
              <td><span id="textShadowBlurRadiusValue-0"></span>em</td>
            </tr>
            <tr>
              <td><span>Margin Bottom: </span></td>
              <td><input id="textMarginSlider-0" type="range" min="0" max="100" step="1" oninput="updateTextMargin(0)"></td>
              <td><span id="textMarginValue-0"></span>px</td>
            </tr>
          </table>
        </td>
        <td>
          <table class="phone-row-table">
            <tr>
              <th colspan="3"><span>Translation Text 1</span></th>
            </tr>
            <tr>
              <td><span>Text Color:</span></td>
              <td><input id=textColorPicker-1 type="color" value="#000000" oninput="updateFontColor(1)"></td>
              <td><span id="textColorValue-1"> #000000 </span></td>
            </tr>
            <tr>
              <td><span>Font Size: </span></td>
              <td><input id=textFontSizeSlider-1 type="range" min="0" max="40" step="1" oninput="updateFontSize(1)"></td>
              <td><span id="textFontSizeValue-1"></span>px</td>
            </tr>
            <tr>
              <td><span>Font Weight: </span></td>
              <td><input id="textFontWeightSlider-1" type="range" min="100" max="900" step="100" oninput=" updateFontWeight(1)"></td>
              <td><span id="textFontWeightValue-1"></span></td>
            </tr>
            <tr>
              <td><span>Font Type: </span></td>
              <td colspan="2"><select id="textFontSelect-1" onchange="updateFontFamily(1)">
              </select> </td>
            </tr>
            <tr>
              <td><span>Stroke Color (A):</span></td>
              <td><input id=textStrokeColorPicker-1-0 type="color" oninput="updateStrokeColor(1, 0)"></td>
              <td><span id="textStrokeColorValue-1-0"></span></td>
            </tr>
            <tr>
              <td><span>Stroke Width (A): </span></td>
              <td><input id="textStrokeWidthSlider-1-0" type="range" min="0" max="0.2" step="0.05" oninput="updateStrokeWidth(1, 0)"></td>
              <td><span id="textStrokeWidthValue-1-0"></span>em</td>
            </tr>
            <tr>
              <td><span>Stroke Color (B):</span></td>
              <td><input id=textStrokeColorPicker-1-1 type="color" oninput="updateStrokeColor(1, 1)"></td>
              <td><span id="textStrokeColorValue-1-1"></span></td>
            </tr>
            <tr>
              <td><span>Stroke Width (B): </span></td>
              <td><input id="textStrokeWidthSlider-1-1" type="range" min="0" max="0.8" step="0.05" oninput="updateStrokeWidth(1, 1)"></td>
              <td><span id="textStrokeWidthValue-1-1"></span>em</td>
            </tr>
            <tr>
              <td><label for="textShadowColorPicker-1">Shadow Color:</label></td>
              <td><input id=textShadowColorPicker-1 type="color" value="#dafffb" oninput="updateTextShadow(1)"></td>
              <td><span id="textShadowColorValue-1"> #dafffb </span></td>
            </tr>
            <tr>
              <td><span>Shadow Blur Radius: </span></td>
              <td><input id="textShadowBlurRadiusSlider-1" type="range" min="0" max="1" step="0.05" oninput="updateTextShadow(1)"></td>
              <td><span id="textShadowBlurRadiusValue-1"></span>em</td>
            </tr>
            <tr>
              <td><span>Margin Bottom: </span></td>
              <td><input id="textMarginSlider-1" type="range" min="0" max="100" step="1" oninput="updateTextMargin(1)"></td>
              <td><span id="textMarginValue-1"></span>px</td>
            </tr>
          </table>
        </td>
        <td>
          <table class="phone-row-table">
            <tr>
              <th colspan="3"><span>Translation Text 2</span></th>
            </tr>
            <tr>
              <td><span>Text Color:</span></td>
              <td><input id=textColorPicker-2 type="color" value="#000000" oninput="updateFontColor(2)"></td>
              <td><span id="textColorValue-2"> #000000 </span></td>
            </tr>
            <tr>
              <td><span>Font Size: </span></td>
              <td><input id=textFontSizeSlider-2 type="range" min="0" max="40" step="1" oninput="updateFontSize(2)"></td>
              <td><span id="textFontSizeValue-2"></span>px</td>
            </tr>
            <tr>
              <td><span>Font Weight: </span></td>
              <td><input id="textFontWeightSlider-2" type="range" min="100" max="900" step="100" oninput=" updateFontWeight(2)"></td>
              <td><span id="textFontWeightValue-2"></span></td>
            </tr>
            <tr>
              <td><span>Font Type: </span></td>
              <td colspan="2"><select id="textFontSelect-2" onchange="updateFontFamily(2)">
              </select> </td>
            </tr>
            <tr>
              <td><span>Stroke Color (A):</span></td>
              <td><input id=textStrokeColorPicker-2-0 type="color" oninput="updateStrokeColor(2, 0)"></td>
              <td><span id="textStrokeColorValue-2-0"></span></td>
            </tr>
            <tr>
              <td><span>Stroke Width (A): </span></td>
              <td><input id="textStrokeWidthSlider-2-0" type="range" min="0" max="0.2" step="0.05" oninput="updateStrokeWidth(2, 0)"></td>
              <td><span id="textStrokeWidthValue-2-0"></span>em</td>
            </tr>
            <tr>
              <td><span>Stroke Color (B):</span></td>
              <td><input id=textStrokeColorPicker-2-1 type="color" oninput="updateStrokeColor(2, 1)"></td>
              <td><span id="textStrokeColorValue-2-1"></span></td>
            </tr>
            <tr>
              <td><span>Stroke Width (B): </span></td>
              <td><input id="textStrokeWidthSlider-2-1" type="range" min="0" max="0.8" step="0.05" oninput="updateStrokeWidth(2, 1)"></td>
              <td><span id="textStrokeWidthValue-2-1"></span>em</td>
            </tr>
            <tr>
              <td><label for="textShadowColorPicker-2">Shadow Color:</label></td>
              <td><input id=textShadowColorPicker-2 type="color" value="#dafffb" oninput="updateTextShadow(2)"></td>
              <td><span id="textShadowColorValue-2"> #dafffb </span></td>
            </tr>
            <tr>
              <td><span>Shadow Blur Radius: </span></td>
              <td><input id="textShadowBlurRadiusSlider-2" type="range" min="0" max="1" step="0.05" oninput="updateTextShadow(2)"></td>
              <td><span id="textShadowBlurRadiusValue-2"></span>em</td>
            </tr>
            <tr>
              <td><span>Margin Bottom: </span></td>
              <td><input id="textMarginSlider-2" type="range" min="0" max="100" step="1" oninput="updateTextMargin(2)"></td>
              <td><span id="textMarginValue-2"></span>px</td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </div>

  <script>
    function getRandomInteger(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function fillArrayWithRandomValue(arr, len, min, max) {
      var randomInteger = getRandomInteger(min, max);
      arr = Array.from({ length: len }, () => randomInteger);
      return arr;
    }
  </script>
  <script>
    var speechListTotalCount = 0;
    function updateSpeechList(text) {
      var speechTextItem = document.createElement('li');
      speechTextItem.textContent = text;
      speechList.appendChild(speechTextItem);
      speechListTotalCount.innerHTML = `Total Count: ${speechList.childNodes.length}`;
    }

    var pageColorPicker = document.getElementById('pageColorPicker');
    var pageColorValue = document.getElementById('pageColorValue');
    var textArea = document.querySelector('.text-area');
    var curtainColorPicker = document.getElementById('curtainColorPicker');
    var curtainColorValue = document.getElementById('curtainColorValue');

    var texts = document.querySelectorAll('[id^="text-"]');
    var displayedTexts = document.querySelectorAll('[id^="displayedText-"]');
    var textColorPickers = document.querySelectorAll('[id^="textColorPicker-"]');
    var textColorValues = document.querySelectorAll('[id^="textColorValue-"]');
    var textFontSizeSliders = document.querySelectorAll('[id^="textFontSizeSlider-"]');
    var textFontSizeValues =  document.querySelectorAll('[id^="textFontSizeValue-"]');
    var textFontWeightSliders = document.querySelectorAll('[id^="textFontWeightSlider-"]');
    var textFontWeightValues = document.querySelectorAll('[id^="textFontWeightValue-"]');
    var textFontFamilySelects = document.querySelectorAll('[id^="textFontSelect-"]');
    var readingSelects = document.querySelectorAll('[id^="readingSelect"]');


    var timeTextUpdated = fillArrayWithRandomValue([], topTranslationCount + 1, 1, 500000);
    var JapanesePosId;

    var textStrokeColorPickers = [];
    for (let i = 0; i < 3; i++) {
      textStrokeColorPickers[i] = [];
      for (let j = 0; j < 2; j++)
        textStrokeColorPickers[i][j] = document.getElementById(`textStrokeColorPicker-${i}-${j}`);
    }
    var textStrokeColorValues = [];
    for (let i = 0; i < 3; i++) {
      textStrokeColorValues[i] = [];
      for (let j = 0; j < 2; j++)
        textStrokeColorValues[i][j] = document.getElementById(`textStrokeColorValue-${i}-${j}`);
    }
    var textStrokeWidthSliders = [];
    for (let i = 0; i < 3; i++) {
      textStrokeWidthSliders[i] = [];
      for (let j = 0; j < 2; j++)
        textStrokeWidthSliders[i][j] = document.getElementById(`textStrokeWidthSlider-${i}-${j}`);
    }
    var textStrokeWidthValues = [];
    for (let i = 0; i < 3; i++) {
      textStrokeWidthValues[i] = [];
      for (let j = 0; j < 2; j++)
        textStrokeWidthValues[i][j] = document.getElementById(`textStrokeWidthValue-${i}-${j}`);
    }
    var textShadowColorPickers = document.querySelectorAll('[id^="textShadowColorPicker-"]');
    var textShadowColorValues = document.querySelectorAll('[id^="textShadowColorValue-"]');
    var textShadowBlurRadiusSliders = document.querySelectorAll('[id^="textShadowBlurRadiusSlider-"]');
    var textShadowBlurRadiusValues = document.querySelectorAll('[id^="textShadowBlurRadiusValue-"]');
    var textMarginSliders = document.querySelectorAll('[id^="textMarginSlider-"]');
    var textMarginValues = document.querySelectorAll('[id^="textMarginValue-"]');
    var textMargins = document.querySelectorAll('[id^="textMargin-"]');
    var apiKeyInputs = document.querySelectorAll('[id^="apiKeyInput-"]');
    var languageSelects = [];
    for (let i = 0; i <= topTranslationCount; i++) {
      languageSelects.push(document.getElementById(`languageSelect-${i}`));
    }
    var azureVoiceSelects = document.querySelectorAll('[id^="azureVoiceSelect-"]');

    var speechOverInterval_TimeOut;
    var speechSplitInterval_TimeOut;
    var speechClearInterval_TimeOut;
    var googleScriptKey;
    var gcpApiKey;
    var azureSpeechSubscriptionKey;
    var azureTranslateSubscriptionKey;
  </script>
  <script>
  const myLocalFonts = [
    'Seto',
    'Naikai',
    'Nishikiteki',
    'Iansui',
    'BugMaruGothic',
    'TaipeiSans',
    'WD-XLLubrifont',
    'tkFangSong',
    'LXGWWenKai',
    'LXGWWenKaiMono',
    'SourceHanSans',
    'SourceHanSerif',
    'XiaoheSimplifySans',
    'XiaoheSimplifySerif',
    'AdvocateAncientMono',
    'NotoSansCJK',
    'NotoSansCJKjp',
    'KosugiMaru',
    'JF-openhuninn',
    '851MkPOP',
    'ChenYuluoyan',
    'KsoKagero',
    'KsoKaisho',
    'Mamelon',
    'OzCaramel',
    'Pigmo-00',
  ];
  const generateAllFontAreaCode = () => {
    textFontFamilySelects.forEach(function(element) {
      element.innerHTML = "";
      myLocalFonts.forEach(font => {
        element.innerHTML += `<option value="${font}">${font}</option>`;
      });
    });
  }
  generateAllFontAreaCode();
  </script>

  <script>
    function handleEnterKeyPress(textareaElement) {
      const buttonElement = textareaElement.parentNode.parentNode.querySelector('button[name="translateButton"]');
      textareaElement.addEventListener("keydown", function (event) {
        if (event.keyCode === 13 && event.shiftKey) {
          event.preventDefault();
          var textarea = event.target;
          var start = textarea.selectionStart;
          var end = textarea.selectionEnd;
          var value = textarea.value;
          textarea.value = value.substring(0, start) + "\n" + value.substring(end);
          textarea.selectionStart = textarea.selectionEnd = start + 1;
        }
        else if (event.keyCode === 13) {
          event.preventDefault();
          buttonElement.click();
        }
      });
    }
    handleEnterKeyPress(recognitionResult);
    handleEnterKeyPress(recordResult);
    handleEnterKeyPress(translateInput);
    handleEnterKeyPress(jpExpInput);
    handleEnterKeyPress(readingListInputArea);


  </script>

  <script>
    var recognizeButton = document.getElementById("recognize-button");
    var recordButton = document.getElementById("record-button");
    var isRecognizing = false;
    var isRecording = false;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();


    /*
    var recognition;
    if ('webkitSpeechRecognition' in window) {
      console.log("'webkitSpeechRecognition' in window")
      recognition = new webkitSpeechRecognition();
    } else if ('SpeechRecognition' in window) {
      console.log("'SpeechRecognition' in window")
      recognition = new SpeechRecognition();
    } else {
      alert("Speech recognition is not supported in this browser.");
    }
    */


    var xmlRequest = new XMLHttpRequest();
    var requests = [];
    for (let i = 0; i < topTranslationCount; i++) {
      requests.push(new XMLHttpRequest());
    }

    function showApiKey(id, button) {
      apiKeyInputs[id].type = "text";
      button.innerHTML = "🤫";
    }
    function hideApiKey(id, button) {
      apiKeyInputs[id].type = "password";
      button.innerHTML = "👁️‍";
    }
    function copyApiKey(id, button) {
      var tempInput = document.createElement("input");
      tempInput.type = "text";
      tempInput.value = apiKeyInputs[id].value;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand("copy");
      document.body.removeChild(tempInput);
    }
    function copyTextArea(button) {
      var textarea = button.parentNode.parentNode.querySelector('textarea');
      textarea.select();
      document.execCommand("copy");
    }
    function pasteToTextArea(button) {
      var textarea = button.parentNode.parentNode.querySelector('textarea');
      if (navigator.clipboard) {
        navigator.clipboard.readText()
          .then(text => {
              textarea.value = text;
          })
          .catch(err => {
              console.error('Failed to read clipboard contents:', err);
          });
      }
    }
    function clearTextArea(button) {
      // nextElementSibling || previousElementSibling
      var textarea = button.parentNode.parentNode.querySelector('textarea');
      textarea.value = "";
    }
    function isPuntuation(character) {
      return /[.,!?;:—–(){}[\]“”‘’"'…・。、？！「」『』（）【】ー]/.test(character);
    }
    function isEnglishLetter(character) {
      return /^[A-Za-z]$/.test(character);
    }
    function addPunctuation(text) {
      if (!text) return "";
      var textTrim = text.trim();
      if (!textTrim) return "";
      var lastCharacter = textTrim[textTrim.length - 1];
      if (isPuntuation(lastCharacter)) return text;
      if (isEnglishLetter(lastCharacter)) return text + ". ";
      else return text + "。 ";
    }
    function startRecognition(sourceLanguage="") {
      console.log("[startRecognition] before-> sourceLanguage:", sourceLanguage);
      if (!sourceLanguage) {
        sourceLanguage = languageSelects[0].value;
      }
      recognitionResult.value = "";
      recognitionPreviousResult.value = "";
      console.log("[startRecognition] after-> sourceLanguage:", sourceLanguage);
      recognition.lang = sourceLanguage;
      recognition.interimResults = true;
      recognition.continuous = true;
      recognitionNonStop = oneSentenceRecognizeToggleButton.innerHTML === '〜';

      var timeStamp = 0;
      recognition.onstart = () => {
        console.log("onstart:", timeStamp);
      }
      recognition.onaudiostart = () => {
        console.log("onaudiostart:", timeStamp);
      }
      recognition.onsoundstart = () => {
        console.log("onsoundstart:", timeStamp);
      }
      recognition.onspeechstart = () => {
        console.log("onspeechstart:", timeStamp);
      }
      recognition.onspeechend = () => {
        console.log("onspeechend:", timeStamp);
      }
      recognition.onsoundend = () => {
        console.log("onsoundend:", timeStamp);
      }
      recognition.onaudioend = () => {
        console.log("onaudioend:", timeStamp);
      }
      recognition.onend = () => {
        console.log("onend:", timeStamp);
        if (isRecognizing) {
          recognition.start();
          timeStamp = timeStamp + 1;
        }
      }
      recognition.onerror = () => {
        console.log("onerror:", timeStamp);
        recognition.stop();
      }
      recognition.onnomatch = () => {
        console.log("onnomatch:", timeStamp);
        recognition.stop();
      }
      stopRecognitionControl = function() {
        console.log(`recognition.stop() after speechSplitInterval(${speechSplitInterval.value}) turns to zero.`);
        recognition.stop();
      }
      recognition.onresult = function(event) {
        console.log("In [recognition.onresult] ", "resultIndex=", event.resultIndex, "resultLength=", event.results.length);
        for (var i = event.resultIndex; i < event.results.length; i++) {
        // { var i = event.results.length - 1;
          var speechText = event.results[i][0].transcript;
          if (!speechText || !speechText.trim()) {
            console.log("Empty Speech Text");
          }
          else {
            console.log("[event.results] speech text:", speechText);
            if (event.results[i].isFinal) {
              if (recognitionNonStop) {
                recognitionResult.value = speechText;
                // recognitionResult.value = recognitionPreviousResult.value + addPunctuation(speechText);
                // recognitionPreviousResult.value = recognitionResult.value;
              }
              else {
                recognitionResult.value = recognitionPreviousResult.value + addPunctuation(speechText);
                recognitionPreviousResult.value = recognitionResult.value;
              }
              if (isRecording) {
                recordResult.value = recordResult.value + addPunctuation(speechText);
              }
              // await
              updateSpeechList(speechText);
              speechTranslate(speechText, sourceLanguage, false, undefined, updateHistoryTextToggleButton.innerHTML === "🎈");
            }
            else {
              if (!recognitionNonStop && speechOverInterval.value && speechOverInterval.value !== 0) {
                clearTimeout(speechOverInterval_TimeOut);
                speechOverInterval_TimeOut = setTimeout(function() {
                  stopRecognitionComplete(sourceLanguage);
                }, speechOverInterval.value);
              }
              else if (speechSplitInterval.value && speechSplitInterval.value !== 0) {
                clearTimeout(speechSplitInterval_TimeOut);
                speechSplitInterval_TimeOut = setTimeout(stopRecognitionControl, speechSplitInterval.value);
              }
              recognitionResult.value = recognitionPreviousResult.value + ' < ' + speechText + ' > ';
            }
          }
        }
      };
      recognition.start();
      timeStamp = timeStamp + 1;
      isRecognizing = true;
      recognizeButton.innerHTML = "⏹️ Stop Recognizing";
    }
    function stopRecognition() {
      if (recognition) {
        recognition.stop();
        console.log("recognition.stop()");
      }
      isRecognizing = false;
      recognizeButton.innerHTML = "▶️ Start Recognizing"
    }
    function stopRecognitionComplete(sourceLanguage) {
      stopRecognition();
      if (isRecording) {
        isRecording = false;
        recordButton.innerHTML = "▶️ Start Recording";
      }
      if (recognitionResult.value !== texts[0].textContent) {
        updateSpeechList(recognitionResult.value);
        speechTranslate(recognitionResult.value, sourceLanguage, false, undefined, updateHistoryTextToggleButton.innerHTML === "🎈");
      }
    }
    function toggleRecognition(sourceLanguage) {
      if (isRecognizing) {
        stopRecognitionComplete(sourceLanguage);
      }
      else {
        startRecognition(sourceLanguage);
        if (!isRecording) {
          isRecording = true;
          recordButton.innerHTML = "⏹️ Stop Recording";
        }
      }
    }
    function recognizeRestart(sourceLanguage) {
      if (!isRecognizing) {
        return;
      }
      toggleRecognition(sourceLanguage);
      setTimeout(function() {
        toggleRecognition(sourceLanguage);
      }, 1200);
    }
    function toggleRecord() {
      if (isRecording) {
        isRecording = false;
        recordButton.innerHTML = "▶️ Start Recording";
      }
      else {
        isRecording = true;
        recordButton.innerHTML = "⏹️ Stop Recording";
      }
    }
    function toggleTextFurigana() {
      textFuriganaToggleButton.innerText = textFuriganaToggleButton.innerText === "🔰" ? "💤" : "🔰";
    }
    function toggleTranslationCount(value=-1, clearBoolean=true) {
      if (value === -1) value = parseInt(translationCountSelect.value, 10);
      else translationCountSelect.value = value;
      translationCount = value;
      if (clearBoolean) {
        clearTexts(translationCount + 1);
        defaultTexts();
      }
      configs[autoSID].translationCount = parseInt(translationCountSelect.value, 10);
      saveConfigStorage();
      timeTextUpdated = fillArrayWithRandomValue([], topTranslationCount + 1, 1, 500000);
    }
    var sourceLanguage = "ja";
    var targetLanguage = "en";
    function inputLanguageSwitch() {
      var button = document.getElementById("inputLanguageSwitch-button");
      if (sourceLanguage == "ja") {
        sourceLanguage = "en";
        targetLanguage = "ja";
        button.innerHTML = "EN🔤"
      } else {
        sourceLanguage = "ja";
        targetLanguage = "en";
        button.innerHTML = "JP🔤"
      }
    }
    function toggleAutoLangaugeDetect(button) {
      button.innerText = button.innerText === "🤔" ? "😴" : "🤔";
    }
    function toggleOneSentenceRecognize(button) {
      button.innerText = button.innerText === "①" ? "〜" : "①";
    }
    function toggleUpdateHistoryText(button) {
      button.innerText = button.innerText === "🎈" ? "🕳️" : "🎈";
    }
    function toggleHistoryTextsMaxLength(value=-1) {
      if (value == -1) value = historyTextsMaxLengthSelect.value;
      else historyTextsMaxLengthSelect.value = value;
      configs[autoSID].historyTextsMaxLength = value;
      saveConfigStorage();
    }

    var ggAudioList = [];
    var msAudioList = [];
    var ggAudioListTmp = [];
    var msAudioListTmp = [];
    async function ggSpeakUrlGet(text, sourceLanguage) {
      if (window.location.protocol === "file:") {
        var url = "https://translate.google.com/translate_tts?ie=UTF-8&tl=" +
          sourceLanguage +  "&client=tw-ob&q=" + encodeURIComponent(text);
        return url;
      }
      else {
        try {
          const response = await fetch('https://snsmile.site:3000/text-to-speech', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              sourceLanguage: sourceLanguage,
              text: text
            })
          });
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          const audioData = await response.arrayBuffer();
          const audioBlob = new Blob([audioData], { type: 'audio/mpeg' });
          return URL.createObjectURL(audioBlob);
        } catch (error) {
          console.error('Error:', error);
          return null; // or handle the error in a way appropriate for your application
        }
      }
    }
    async function ggSpeak(text, sourceLanguage = "") {
      console.log("ggSpeak text:", text);
      if (!text) return;
      if (sourceLanguage === "") {
        sourceLanguage = "ja";
      }
      if (ggSpeakAudio) {
        ggSpeakAudio.pause();
      }
      ggSpeakAudio.src = await ggSpeakUrlGet(text, sourceLanguage);
      ggSpeakAudio.play();
      /* if ("speechSynthesis" in window) {
        var speechSynthesis = window.speechSynthesis;
        var utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = sourceLanguage;
        speechSynthesis.speak(utterance);
      }
      */
    }

		const MSTTS_region = "southeastasia";
		const MSTTS_endpoint1 = `https://${MSTTS_region}.api.cognitive.microsoft.com/sts/v1.0/issuetoken`;
		const MSTTS_endpoint2 = `https://${MSTTS_region}.tts.speech.microsoft.com/cognitiveservices/v1`;
    function getMsttsAccessToken() {
      return new Promise((resolve, reject) => {
        var xhr1 = new XMLHttpRequest();
        xhr1.open('POST', MSTTS_endpoint1);
        xhr1.setRequestHeader('Ocp-Apim-Subscription-Key', azureSpeechSubscriptionKey);
        xhr1.send();
        xhr1.onreadystatechange = function() {
          if (xhr1.readyState === 4) {
            if (xhr1.status === 200) {
              var accessToken = xhr1.responseText;
              resolve(accessToken);
            } else {
              reject(new Error(`Failed to get Azure Access Token. Status code: ${xhr1.status}`));
            }
          }
        };
        xhr1.onerror = function() {
          reject(new Error('Request error'));
        };
      });
    }
    async function getMsAudioData(text, sourceLanguage, MSTTS_voiceName, accessToken) {
      return new Promise((resolve, reject) => {
        const xhr2 = new XMLHttpRequest();
        const headers = {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/ssml+xml",
          "X-Microsoft-OutputFormat": "audio-16khz-128kbitrate-mono-mp3"
        };
        xhr2.open('POST', MSTTS_endpoint2);
        for (const [key, value] of Object.entries(headers)) {
          xhr2.setRequestHeader(key, value);
        }
        xhr2.responseType = 'arraybuffer';
        const requestBody = `<speak version='1.0' xml:lang='en-US'><voice name='${MSTTS_voiceName}'>${text}</voice></speak>`;
        xhr2.onload = function() {
          if (xhr2.status >= 200 && xhr2.status < 300) {
            resolve(xhr2.response);
          } else {
            reject(new Error(`Request failed with status ${xhr2.status}`));
          }
        };
        xhr2.onerror = function() {
          reject(new Error('Request error'));
        };
        xhr2.send(requestBody);
      });
    }
    function updateAzureVoice(id, value="") {
      if (!value) value = azureVoiceSelects[id].value;
      else azureVoiceSelects[id].value = value;
      configs[autoSID].azureVoices[id] = value;
      saveConfigStorage();
    }
    async function msSpeak(text, sourceLanguage = "") {
      console.log("msSpeak-text:", text);
      if (!text) return;
      var MSTTS_voiceName;
      if (sourceLanguage === "ja") {
        MSTTS_voiceName = azureVoiceSelects[0].value;
      } else if (sourceLanguage === "en") {
        MSTTS_voiceName = azureVoiceSelects[1].value;
      } else if (sourceLanguage === "zh-TW") {
        MSTTS_voiceName = azureVoiceSelects[2].value;
      }
      try {
        const accessToken = await getMsttsAccessToken();
        const audioData = await getMsAudioData(text, sourceLanguage, MSTTS_voiceName, accessToken);
        const audioBlob = new Blob([audioData], { type: 'audio/mpeg' });
        msSpeakAudio.src = URL.createObjectURL(audioBlob);
        msSpeakAudio.play();
      } catch (error) {
        console.error("Error while executing msSpeak:", error);
      }
    }

    function msPauseAudio() {
      if (msSpeakAudio) {
        if (msSpeakAudio.paused) {
          msSpeakAudio.play();
        } else {
          msSpeakAudio.pause();
        }
      }
    }
    function ggPauseAudio() {
      if (ggSpeakAudio) {
        if (ggSpeakAudio.paused) {
          ggSpeakAudio.play();
        } else {
          ggSpeakAudio.pause();
        }
      }
    }

    function clearReadingList() {
      ggAudioList = [];
      msAudioList = [];
      while (readingList.firstChild) {
        readingList.removeChild(readingList.firstChild);
      }
    }
    function chooseAzureVoice(sourceLanguage) {
      if (sourceLanguage === "ja") {
        return azureVoiceSelects[0].value;
      } else if (sourceLanguage === "en") {
        return azureVoiceSelects[1].value;
      } else if (sourceLanguage === "zh-TW") {
        return azureVoiceSelects[2].value;
      }
    }
    async function addToGgReadingList(ggAudioList, lines=1) {
      /* if (targetLanguages === undefined || targetLanguages.length === 0) {
        await getTargetLanguages();
        console.log("targetLanguages: ", targetLanguages);
      }*/
      for (let i = 0; i < lines; i++) {
        var url = await ggSpeakUrlGet(texts[i].textContent, readingSelects[i].value);
        ggAudioList.push(url);
      }
      console.log("ggAudioList:", ggAudioList);
    }
    async function addToMsReadingList(msAudioList, lines = 1) {
      /* if (targetLanguages === undefined || targetLanguages.length === 0) {
        await getTargetLanguages();
      } */
      try {
        const accessToken = await getMsttsAccessToken();
        for (let i = 0; i < lines; i++) {
          var MSTTS_voiceName = chooseAzureVoice(readingSelects[i].value);
          const audioData = await getMsAudioData(texts[i].textContent, readingSelects[i].value, MSTTS_voiceName, accessToken);
          msAudioList.push(audioData);
        }
        console.log("msAudioList:", msAudioList);
        return msAudioList;
      } catch (error) {
        console.error("Error while adding to MsReadingList:", error);
        throw error;
      }
    }

    async function addToReadingList(ggAudioList, msAudioList, lines=1, isAutoDetect=false, languageSelect=undefined) {
      await addToGgReadingList(ggAudioList, lines);
      await addToMsReadingList(msAudioList, lines);
      for (let i = 0; i < lines; i++) {

        let readingListItem = document.createElement('li');
        readingListItem.textContent = texts[i].textContent + ` - [${readingSelects[i].value}]`;

        let ggSpeakReadingListItemButton = document.createElement('button');
        ggSpeakReadingListItemButton.textContent = 'G';
        let msSpeakReadingListItemButton = document.createElement('button');
        msSpeakReadingListItemButton.textContent = 'M';
        let removeReadingListItemButton = document.createElement('button');
        removeReadingListItemButton.textContent = '⛔';

        let buttonContainer =  document.createElement('span');
        buttonContainer.appendChild(ggSpeakReadingListItemButton);
        buttonContainer.appendChild(msSpeakReadingListItemButton);
        buttonContainer.appendChild(removeReadingListItemButton);

        let itemContainer = document.createElement('div');
        itemContainer.style.display = 'flex';
        itemContainer.style.justifyContent = 'space-between';
        itemContainer.appendChild(readingListItem);
        itemContainer.appendChild(buttonContainer);

        removeReadingListItemButton.addEventListener('click', function() {
          const index = Array.from(readingList.children).indexOf(itemContainer);
          ggAudioList.splice(index, 1);
          msAudioList.splice(index, 1);
          itemContainer.remove();
        });
        ggSpeakReadingListItemButton.addEventListener('click', function() {
          const index = Array.from(readingList.children).indexOf(itemContainer);
          ggSpeakSingleAudioOfList(index);
        });
        msSpeakReadingListItemButton.addEventListener('click', function() {
          const index = Array.from(readingList.children).indexOf(itemContainer);
          msSpeakSingleAudioOfList(index);
        });

        readingList.appendChild(itemContainer);
      }
    }
    function sentenceSplit(sentence) {
      var values = sentence.split(' - [');
      var text = values[0];
      var language = values[1].slice(0, -1);
      return [text, language];
    }
    function addToFavoriteList() {
      for (let i = 0; i <= topTranslationCount; i++) {

        let favoriteListItem = document.createElement('li');
        favoriteListItem.textContent = texts[i].textContent + ` - [${targetLanguages[i]}]`;

        let ggSpeakFavoriteListItemButton = document.createElement('button');
        ggSpeakFavoriteListItemButton.textContent = 'G';
        let msSpeakFavoriteListItemButton = document.createElement('button');
        msSpeakFavoriteListItemButton.textContent = 'M';
        let removeFavoriteListItemButton = document.createElement('button');
        removeFavoriteListItemButton.textContent = '⛔';

        let buttonContainer =  document.createElement('span');
        // buttonContainer.appendChild(ggSpeakFavoriteListItemButton);
        // buttonContainer.appendChild(msSpeakFavoriteListItemButton);
        buttonContainer.appendChild(removeFavoriteListItemButton);

        let itemContainer = document.createElement('div');
        itemContainer.style.display = 'flex';
        itemContainer.style.justifyContent = 'space-between';
        itemContainer.appendChild(favoriteListItem);
        itemContainer.appendChild(buttonContainer);

        removeFavoriteListItemButton.addEventListener('click', function() {
          const index = Array.from(favoriteList.children).indexOf(itemContainer);
          itemContainer.remove();
        });
        ggSpeakFavoriteListItemButton.addEventListener('click', function() {
          const index = Array.from(favoriteList.children).indexOf(itemContainer);
          ggSpeak(...sentenceSplit(favoriteListItem.textContent));
        });
        msSpeakFavoriteListItemButton.addEventListener('click', function() {
          const index = Array.from(favoriteList.children).indexOf(itemContainer);
          msSpeak(...sentenceSplit(favoriteListItem.textContent));
        });
        favoriteList.appendChild(itemContainer);
      }
    }

    async function ggSpeakReadingList(ggAudioList, repeatTime) {
      if (ggSpeakAudio) {
        ggSpeakAudio.pause();
      }
      var totalRepeatTime = ggAudioList.length * Math.abs(repeatTime);
      var currentAudioIndex = 0;
      console.log("ggAudioList.length:", ggAudioList.length);
      console.log("totalRepeatTime:", totalRepeatTime);
      ggSpeakAudio.addEventListener('ended', function() {
        currentAudioIndex++;
        if (currentAudioIndex < totalRepeatTime) {
          ggSpeakAudio.pause();
          var i = currentAudioIndex % ggAudioList.length;
          ggSpeakAudio.src = ggAudioList[i];
          ggSpeakAudio.play();
        }
      });
      ggSpeakAudio.src = ggAudioList[currentAudioIndex];
      ggSpeakAudio.play();
    }
    async function ggSpeakSingleAudioOfList(index) {
      if (ggSpeakAudio) {
        ggSpeakAudio.pause();
      }
      ggSpeakAudio.src = ggAudioList[index];
      ggSpeakAudio.play();
    }

    async function msSpeakReadingList(msAudioList, repeatTime) {
      if (msSpeakAudio) {
        msSpeakAudio.pause();
      }
      var totalRepeatTime = msAudioList.length * Math.abs(repeatTime);
      console.log("msAudioList.length:", msAudioList.length);
      console.log("totalRepeatTime:", totalRepeatTime);
      function msListPlayAudio(currentAudioIndex) {
        if (currentAudioIndex >= totalRepeatTime) return;
        var i = currentAudioIndex % msAudioList.length;
        var audioDataCopy = msAudioList[i].slice();
        const audioData = msAudioList[i];
        const audioBlob = new Blob([audioData], { type: 'audio/mpeg' });
        msSpeakAudio.src = URL.createObjectURL(audioBlob);
        msSpeakAudio.onended = function() {
          msAudioList[i] = audioDataCopy;
          msListPlayAudio(currentAudioIndex + 1);
        };
        msSpeakAudio.play();
      }
      msListPlayAudio(0);
    }
    async function msSpeakSingleAudioOfList(index) {
      if (msSpeakAudio) {
        msSpeakAudio.pause();
      }
      var audioDataCopy = msAudioList[index].slice();
      const audioData = msAudioList[index];
      const audioBlob = new Blob([audioData], { type: 'audio/mpeg' });
      msSpeakAudio.src = URL.createObjectURL(audioBlob);
      msSpeakAudio.play();
    }

    function saveFavoriteTextConfigStorage() {
      var configJSON = JSON.stringify(favoriteHistoryTexts);
      localStorage.setItem(`snowyTranslatorTextConfig[${favID}]`, configJSON);
    }
    function loadFavoriteTextConfigStorage() {
      favoriteHistoryTexts = JSON.parse(localStorage.getItem(`snowyTranslatorTextConfig[${favID}]`));
    }
    function addFavoriteText() {
      for (let i = 0; i <= translationCount; i++) {

      }
      favoriteHistoryTexts.push([...texts].map(element => element.innerHTML));
      saveFavoriteTextConfigStorage();
    }
    function loadFavoriteText() {
      // textConfig.historyTexts = textConfig.favoriteHistoryTexts;
      // textConfig.historyTextsLanguages = textConfig.favoriteHistoryTextsLanguages;
      // updateHistoryTextCurrentId(textConfig.historyTexts.length - 1);
    }

    async function ggDetectLanguage(text) {
      const url = `https://translation.googleapis.com/language/translate/v2/detect?key=${gcpApiKey}`;
      const data = {
        q: text
      };
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });
        const responseData = await response.json();
        var detectedLanguage = responseData.data.detections[0][0].language;
        var confidence = responseData.data.detections[0][0].confidence;
        console.log(`Detected Language: ${detectedLanguage} (Confidence: ${confidence})`);
        if (detectedLanguage === "zh-CN") {
          detectedLanguage = "zh-TW";
        }
        if ((detectedLanguage === "zh-CN" || detectedLanguage === "zh-TW") && confidence < 0.93) {
          detectedLanguage = "ja";
        }
        return detectedLanguage;
      } catch (error) {
        console.error('ggDetectLanguage Error:', error);
      }
    }

    async function detectLanguageFromMyServer(text) {
      try {
        // const response = await fetch('http://localhost:3001/detect-language', {
        const response = await fetch('https://snsmile.site:3001/detect-language', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            text: text
          })
        })
        const data = await response.json();
        return data.language;
      } catch (error) {
       console.error('Error:', error);
       return text + "🌐🚨";
      }
    }

    async function autoDetectTranslate(text, languageSelect=undefined) {
      console.log("AutoDetectTranslate:", text);
      var sourceLanguage;
      if (gcpApiKey) {
        sourceLanguage = await ggDetectLanguage(text);
        // console.log("ggDetectLanguage():", sourceLanguage);
      }
      else {
        sourceLanguage = await detectLanguageFromMyServer(text);
        console.log("DetectLanguageFromMyServer():", sourceLanguage);
      }
      if (!sourceLanguage) {
        if (languageSelect) {
          sourceLanguage = languageSelect.value;
        }
        else {
          sourceLanguage = languageSelects[0].value;
        }
      }

      console.log("autoDetectTranslate() sourceLanguage:", sourceLanguage);
      if (languageSelect !== undefined) {
        languageSelect.value = sourceLanguage;
      }
      return sourceLanguage;
    }

    function ggTranslate(text) {
      var text = $("#inputArea").val();
      if (googleScriptKey) {
        query = `https://script.google.com/macros/s/${googleScriptKey}/exec?`
          + `text=${text}`
          + `&source=${sourceLanguage}`
          + `&target=${targetLanguage}`;
        xmlRequest.open('GET', query, true);
        xmlRequest.onreadystatechange = function(){
          if (xmlRequest.readyState === 4 && xmlRequest.status === 200){
            return xmlRequest.responseText;
          }
        }
        xmlRequest.send(null);
      }
    }

    var targetLanguages;
    async function getTargetLanguages(sourceLanguage="") {
      if (!sourceLanguage) {
        sourceLanguage = await autoDetectTranslate(texts[0].textContent);
      }
      targetLanguages = [];
      targetLanguages.push(sourceLanguage);
      for (let i = 0; i <= topTranslationCount; i++) {
        if (languageSelects[i].value != sourceLanguage) {
          targetLanguages.push(languageSelects[i].value);
        }
        readingSelects[i].value = targetLanguages[i];
      }
    }

    function jpExpWebUpdate(speechText) {
      if (jpExpWebTop.style.display === 'block') {
        var noSpaceSpeechText = speechText.replace(/\s+/g, "");
        var encodedSpeechText = encodeURIComponent(noSpaceSpeechText);
        var ichimoe_url = "https://ichi.moe/cl/qr/?q=" + encodedSpeechText;
        jpExpWebTop.src = ichimoe_url;
      }
      if (jpExpWebBot.style.display === 'block') {
        var noSpaceSpeechText = speechText.replace(/\s+/g, "");
        var encodedSpeechText = encodeURIComponent(noSpaceSpeechText);
        var ichimoe_url = "https://ichi.moe/cl/qr/?q=" + encodedSpeechText;
        jpExpWebBot.src = ichimoe_url;
      }
    }
    async function speechTranslate(speechText, sourceLanguage="", isAutoDetect=false, languageSelect=undefined, willUpdateHistoryText=true) {
      if (!speechText) {
        return;
      }
      updateText(0, speechText, true, willUpdateHistoryText);
      console.log("[speechTranslate] before-> sourceLanguage:", sourceLanguage);
      console.log("[speechTranslate] speechText:", speechText);
      if (!sourceLanguage || isAutoDetect && gcpApiKey) {
        sourceLanguage = await autoDetectTranslate(speechText, languageSelect);
      }
      if (sourceLanguage === "ja") {
        jpExpWebUpdate(speechText);
        // var html = await japaneseExplanationFromMyServer(speechText);
        // updateTextWithFurigana(0, html);
        JapanesePosId = 0;
      }
      await getTargetLanguages(sourceLanguage);
      console.log("[speechTranslate] after-> targetLanguages:", targetLanguages);
      if (googleScriptKey) {
        const requestsPromises = [];
        for (let i = 1; i <= translationCount; i++) {
          const targetLanguage = targetLanguages[i];
          const promise = new Promise((resolve, reject) => {
            const query = `https://script.google.com/macros/s/${googleScriptKey}/exec?`
              + `text=${speechText}`
              + `&source=${sourceLanguage}`
              + `&target=${targetLanguage}`;
            const xhr = new XMLHttpRequest();
            xhr.open('GET', query, true);
            xhr.onreadystatechange = async function () {
              if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                  updateText(i, xhr.responseText, true, willUpdateHistoryText);
                  if (targetLanguage === "ja") {
                    jpExpWebUpdate(xhr.responseText);
                    // var html = await japaneseExplanationFromMyServer(xhr.responseText);
                    // updateTextWithFurigana(i, html);
                    JapanesePosId = i;
                  }
                  resolve();
                } else {
                  reject(new Error('Failed to finish speechTranslate()'));
                }
              }
            };
            xhr.send();
          });
          requestsPromises.push(promise);
        }
        return Promise.all(requestsPromises);
      } else {
        return Promise.resolve();
      }
    }
    function toggleWidgetArea(widgetName, button) {
      var widget = document.getElementById(widgetName);
      var splitPos = button.innerHTML.lastIndexOf(' ');
      var buttonText = button.innerHTML.substr(0, splitPos);
      var trigger = button.innerHTML.substr(splitPos + 1);
      // length('🟢') = 2; length('❌') = 1;
      trigger = trigger === '🟢' ? '❌' : '🟢';
      button.innerHTML = `${buttonText} ${trigger}`;
      widget.style.display = trigger === '🟢' ? 'block' : 'none';
      // compact = inline || block
      var buttonClicked = !layoutButtonsClickedMap.get(buttonText);
      layoutButtonsClickedMap.set(buttonText, buttonClicked);
      configs[autoSID].layoutButtonsClickedList = configs[autoSID].layoutButtonsClickedList.filter(item => item !== buttonText);
      if (buttonClicked) {
        configs[autoSID].layoutButtonsClickedList.push(buttonText);
      }
      saveConfigStorage();
    }
    function saveConfigStorage() {
      var configJSON = JSON.stringify(configs);
      localStorage.setItem('snowyTranslatorConfig', configJSON);
    }
    function saveTextConfigStorage(configID) {
      var configJSON = JSON.stringify(textConfig);
      localStorage.setItem(`snowyTranslatorTextConfig[${configID}]`, configJSON);
    }
    function loadConfigStorage() {
      console.log("loadConfigStorage():");
      if (localStorage.getItem('snowyTranslatorConfig')) {
        configs = JSON.parse(localStorage.getItem('snowyTranslatorConfig'));
      }
    }
    function loadTextConfigStorage(configID) {
      console.log("loadTextConfigStorage():");
      if (localStorage.getItem(`snowyTranslatorTextConfig[${configID}]`)) {
        textConfig = JSON.parse(localStorage.getItem(`snowyTranslatorTextConfig[${configID}]`));
      }
    }
    function updatePageColor(color = "") {
      if (color === "") color = pageColorPicker.value;
      else pageColorPicker.value = color;
      pageColorValue.innerHTML = color;
      document.body.style.backgroundColor = color;
      configs[autoSID].pageColor = color;
      saveConfigStorage();
    }
    function updateCurtainColor(color = "") {
      if (color === "") color = curtainColorPicker.value;
      else curtainColorPicker.value = color;
      curtainColorValue.innerHTML = color;
      textArea.style.background = color;
      configs[autoSID].curtainColor = color;
      saveConfigStorage();
    }
    function updateDisplayedText(id, speechText) {
      displayedTexts[id].textContent = speechText;
      displayedTexts[id].setAttribute('stroke-data', displayedTexts[id].textContent);
      adjustTextAreaHeight();
      configs[autoSID].displayedTexts[id] = speechText;
      saveConfigStorage();
    }
    function updateText(id, speechText, isNotHistoryText=true, willUpdateHistoryText=true) {
      texts[id].innerHTML = speechText;
      configs[autoSID].texts[id] = speechText;
      updateDisplayedText(id, speechText);
      timeTextUpdated[id] += 1;

      if (speechText.trim() !== "" && isNotHistoryText) {
        var allTextUpdated = true;
        console.log("timeTextUpdated:", timeTextUpdated);
        for (let i = 1; i <= translationCount; i++) {
          if (timeTextUpdated[i] != timeTextUpdated[0]) {
            allTextUpdated = false;
            break;
          }
        }
        if (allTextUpdated) {
          console.log("allTextUpdated!");
          if (willUpdateHistoryText) {
            pushHistoryText();
          }

          // console.log("texts[JapanesePosId]", texts[JapanesePosId]);
          if (textFuriganaToggleButton.innerText === "🔰") {
            setTimeout(() => {
              japaneseExplanationFromMyServer(texts[JapanesePosId].textContent)
              .then((html) => updateTextWithFurigana(JapanesePosId, html))
              .catch((error) => console.error(error));
            }, 500);
          }
        }
      }
      // saveConfigStorage();
    }
    function updateHistoryTextCurrentId(pos) {
      configs[autoSID].historyTextsCurrentId = pos;
      historyTextsIdDisplay.innerHTML = `${pos + 1}/${textConfig.historyTexts.length}`;
      saveConfigStorage();
    }
    function pushHistoryText() {
      if (textConfig.historyTexts.length > 0 && textConfig.historyTexts[textConfig.historyTexts.length - 1][0] === texts[0].textContent) {
          return;
      }
      textConfig.historyTexts.push([...texts].map(element => element.textContent));
      textConfig.historyTextsLanguages.push([...targetLanguages]);
      while (textConfig.historyTexts.length > configs[autoSID].historyTextsMaxLength) {
        textConfig.historyTexts.shift();
        textConfig.historyTextsLanguages.shift();
      }
      updateHistoryTextCurrentId(textConfig.historyTexts.length - 1);
      saveTextConfigStorage(autoSID);
    }
    function showHistoryText(index) {
      if (index < 0 || index >= textConfig.historyTexts.length) {
        return;
      }
      console.log(" textConfig.historyTexts:",  textConfig.historyTexts);
      console.log(" textConfig.historyTextsLanguages:",  textConfig.historyTextsLanguages);
      updateHistoryTextCurrentId(index);
      for (let i = 0; i <= translationCount; i++) {
        updateText(i, textConfig.historyTexts[index][i], false);
        readingSelects[i].value = textConfig.historyTextsLanguages[index][i];
      }
    }
    function updateTextWithFurigana(id, htmlText) {
      displayedTexts[id].innerHTML = htmlText;
      displayedTexts[id].setAttribute('stroke-data', "");
    }
    function copyText(id) {
      var text = document.getElementById(`text-${id}`).textContent;
      navigator.clipboard.writeText(text);
    }
    function clearTexts(firstRow=0, topRow=-1) {
      if (topRow === -1) {
        topRow = topTranslationCount;
      }
      for (let i = firstRow; i <= topRow; i++) {
        updateText(i, "");
      }
    }
    function defaultTexts(topRow=-1) {
      if (topRow === -1) {
        topRow = translationCount;
      }
      for (let i = 0; i <= topRow; i++) {
        updateText(i, defaultConfig.texts[i], false);
      }
    }
    function updateFontColor(id, color="") {
      if (color === "") color = textColorPickers[id].value;
      else textColorPickers[id].value = color;
      textColorValues[id].innerHTML = color;
      texts[id].style.color = color;
      configs[autoSID].textFontColors[id] = color;
      saveConfigStorage();
    }
    function updateFontSize(id, value="") {
      if (value === "") value = textFontSizeSliders[id].value;
      else textFontSizeSliders[id].value = value;
      textFontSizeValues[id].innerHTML = value;
      displayedTexts[id].style.fontSize = value + 'px';
      configs[autoSID].textFontSizes[id] = value;
      saveConfigStorage();
    }
    function updateFontWeight(id, value="") {
      if (value === "") value = textFontWeightSliders[id].value;
      else textFontWeightSliders[id].value = value;
      textFontWeightValues[id].innerHTML = value;
      displayedTexts[id].style.fontWeight = value;
      configs[autoSID].textFontWeights[id] = value;
      saveConfigStorage();
    }
    function updateFontFamily(id, value="") {
      if (value === "") value = textFontFamilySelects[id].value;
      else {
        textFontFamilySelects[id].value = value;
      }
      displayedTexts[id].style.fontFamily = value;
      configs[autoSID].textFontFamilies[id] = value;
      saveConfigStorage();
    }
    function updateStrokeColor(id, layer, color="") {
      if (color === "") color = textStrokeColorPickers[id][layer].value;
      else textStrokeColorPickers[id][layer].value = color;
      textStrokeColorValues[id][layer].innerHTML = color;
      displayedTexts[id].style.setProperty(`--stroke-color-layer-${layer}`, color);
      configs[autoSID].textStrokeColors[id][layer] = color;
      saveConfigStorage();
    }
    function updateStrokeWidth(id, layer, value="") {
      if (value === "") value = textStrokeWidthSliders[id][layer].value;
      else textStrokeWidthSliders[id][layer].value = value;
      textStrokeWidthValues[id][layer].innerHTML = value;
      displayedTexts[id].style.setProperty(`--stroke-width-layer-${layer}`, value + "em");
      configs[autoSID].textStrokeWidths[id][layer] = value;
      saveConfigStorage();
    }
    function updateTextShadow(id, radius="", color="") {
      if (radius === "") radius = textShadowBlurRadiusSliders[id].value;
      else textShadowBlurRadiusSliders[id].value = radius;
      if (color === "") color = textShadowColorPickers[id].value;
      else textShadowColorPickers[id].value = color;
      textShadowBlurRadiusValues[id].innerHTML = radius;
      textShadowColorValues[id].innerHTML = color;
      displayedTexts[id].style.textShadow = `0 0 ${radius}em ${color}`;
      configs[autoSID].textShadowBlurRadius[id] = radius;
      configs[autoSID].textShadowColors[id] = color;
      saveConfigStorage();
    }
    function updateTextMargin(id, value="") {
      if (value === "") value = textMarginSliders[id].value;
      else textMarginSliders[id].value = value;
      textMarginValues[id].innerHTML = value;
      textMargins[id].style.marginTop = value + "px";
      configs[autoSID].textMargins[id] = value;
      saveConfigStorage();
    }
    function updateApiKey(id, value="") {
      if (id === 99) {
        console.log("value:", value);
        let values = value.replace(/[^\w-,]/g, '').split(',');
        console.log("values:", values);
        for (let i = 0; i < 4; i++) {
          if (values.length >= i + 1) updateApiKey(i, values[i]);
        }
        return;
      }
      if (value === "") value = apiKeyInputs[id].value;
      else apiKeyInputs[id].value = value;
      configs[autoSID].apiKeys[id] = value;
      if (id === 0) {
        googleScriptKey = value;
      }
      else if (id === 1) {
        gcpApiKey = value;
      }
      else if (id === 2) {
        azureSpeechSubscriptionKey = value;
      }
      else if (id === 3) {
        azureTranslateSubscriptionKey = value;
      }
      saveConfigStorage();
    }
    function updateIntegerValue(intervalInput, value=-1) {
      var intervalInputElement = document.getElementById(intervalInput);
      if (value === -1) value = intervalInputElement.value;
      else intervalInputElement.value = value;
      configs[autoSID][intervalInputElement.id] = value;
      saveConfigStorage();
    }
    function updateLanguage(id, value="") {
      if (value === "") value = languageSelects[id].value;
      else languageSelects[id].value = value;
      configs[autoSID].languages[id] = value;
      saveConfigStorage();
    }
    function saveConfig(configID) {
      console.log(`Save Config (${configID}) ing...`);
      configs[configID].pageColor = pageColorPicker.value;
      configs[configID].curtainColor = curtainColorPicker.value;
      configs[configID].texts = [...texts].map(element => element.innerHTML);
      configs[configID].displayedTexts = [...displayedTexts].map(element => element.innerHTML);
      configs[configID].textFontColors = [...textColorValues].map(element => element.innerHTML);
      configs[configID].textFontSizes = [...textFontSizeValues].map(element => element.innerHTML);
      configs[configID].textFontWeights = [...textFontWeightValues].map(element => element.innerHTML);
      configs[configID].textFontFamilies = [...textFontFamilySelects].map(element => element.value);
      configs[configID].textStrokeColors = textStrokeColorValues.map(elements => [elements[0].innerHTML, elements[1].innerHTML]);
      configs[configID].textStrokeWidths = textStrokeWidthValues.map(elements => [elements[0].innerHTML, elements[1].innerHTML]);
      configs[configID].textShadowBlurRadius = [...textShadowBlurRadiusValues].map(element => element.innerHTML);
      configs[configID].textShadowColors = [...textShadowColorValues].map(element => element.innerHTML);
      configs[configID].textMargins = [...textMarginValues].map(element => element.innerHTML);
      configs[configID].apiKeys = [...apiKeyInputs].map(element => element.value);
      configs[configID].speechOverInterval = speechOverInterval.value;
      configs[configID].speechSplitInterval = speechSplitInterval.value;
      configs[configID].speechClearInterval = speechClearInterval.value;
      configs[configID].translationCount = parseInt(translationCountSelect.value, 10);
      configs[configID].languages = [...languageSelects].map(element => element.value);
      configs[configID].azureVoices = [...azureVoiceSelects].map(element => element.value);
      configs[configID].layoutButtonsClickedList = saveMap(layoutButtonsClickedMap);
      saveConfigStorage();
      configs[configID].historyTextsMaxLength = configs[autoSID].historyTextsMaxLength;
      configs[configID].historyTextsCurrentId = configs[autoSID].historyTextsCurrentId;

      console.log("configs[configID].historyTextsCurrentId:", configs[configID].historyTextsCurrentId);

      saveConfigStorage();
      saveTextConfigStorage(configID);
      console.log(`Save Config (${configID}) Finished.`);
    }
    function loadConfig(configID) {
      loadConfigStorage();
      if (configID === -1) {
        configs[autoSID] = copyConfig(defaultConfig);
        configID = autoSID;
        textConfig = copyConfig(defaultTextConfig);
      }
      else {
        loadTextConfigStorage(configID);
      }

      saveTextConfigStorage(autoSID);
      console.log(`Load Config (${configID}) ing...`);

      toggleTranslationCount(configs[configID].translationCount);

      updatePageColor(configs[configID].pageColor);
      updateCurtainColor(configs[configID].curtainColor);
      updateIntegerValue("speechOverInterval", configs[configID].speechOverInterval);
      updateIntegerValue("speechSplitInterval", configs[configID].speechSplitInterval);
      updateIntegerValue("speechClearInterval", configs[configID].speechClearInterval);
      toggleTranslationCount(configs[configID].translationCount);
      toggleHistoryTextsMaxLength(configs[configID].historyTextsMaxLength);
      showHistoryText(configs[configID].historyTextsCurrentId, false);

      for (let i = 0; i <= translationCount; i++) {
        updateFontColor(i, configs[configID].textFontColors[i]);
        updateFontSize(i, configs[configID].textFontSizes[i]);
        updateFontWeight(i, configs[configID].textFontWeights[i]);
        updateFontFamily(i, configs[configID].textFontFamilies[i]);
        for (let j = 0; j <= 1; j++) {
          updateStrokeColor(i, j, configs[configID].textStrokeColors[i][j]);
          updateStrokeWidth(i, j, configs[configID].textStrokeWidths[i][j]);
        }
        updateTextShadow(i, configs[configID].textShadowBlurRadius[i], configs[configID].textShadowColors[i]);
        updateTextMargin(i, configs[configID].textMargins[i]);
        updateLanguage(i, configs[configID].languages[i]);
        updateAzureVoice(i, configs[configID].azureVoices[i]);
      }
      for (let i = 0; i < apiKeyInputs.length; i++) {
        if (configs[configID].apiKeys[i]) {
          updateApiKey(i, configs[configID].apiKeys[i]);
        }
        else if (apiKeyInputs[i].value) {
          updateApiKey(i);
        }
      }
      // cancel the clicked buttons now
      layoutButtonsClickedMap.forEach((value, key) => {
        if (value) {
          console.log("layoutButtonsClickedMap:", key);
          updateLayoutButtonClick(key);
        }
      });
      // triggle the clicked buttons saved
      if (Array.isArray(configs[configID].layoutButtonsClickedList)) {
        configs[configID].layoutButtonsClickedList.forEach((key) => {
          updateLayoutButtonClick(key);
        });
      }
      console.log(`Load Config (${configID}) Finsihed.`);
    }
    function updateConfig(configID, key, value) {
      configs[configID][key] = value;
      saveConfig(configID);
    }
    function formatJpExp(jpExp, hasRomaji=true) {
      var elements = jpExp.split('<br>');
      var jpExpAreaLength = document.getElementById("jpExpArea").offsetWidth;
      var jpExpAreaTest = $('#jpExpAreaTest');
      var lineLength = 0;
      var html = "";
      for (let i = 0; i < elements.length; i++) {
        var line = elements[i];
        jpExpAreaTest.html(line);
        sentenceLength = jpExpAreaTest.width();
        if (sentenceLength > jpExpAreaLength) {
          if (i > 0) {
            html += "<br>";
          }
          html += line;
          if (i < elements.length - 1) {
            html += "<br>";
          }
        } else {
          if (lineLength + sentenceLength > jpExpAreaLength) {
            html += "<br>";
            lineLength = 0;
          }
          lineLength += sentenceLength;
          html += line;
        }
      }
      return(html);
    }
    async function ScrapeJpExp(text) {
      var jpExp = "";
      try {
        const url = 'https://ichi.moe/cl/qr/?q=' + encodeURIComponent(text);
        const response = await fetch(url);
        const html = await response.text();
        const parser = new DOMParser();
        const soup = parser.parseFromString(html, 'text/html');
        const row_gloss_rows = soup.querySelectorAll('.row.gloss-row:not(.hidden)');
        for (let i = 0; i < row_gloss_rows.length; i++) {
          const row_gloss_row = row_gloss_rows[i];
          const glosses = row_gloss_row.getElementsByClassName('gloss');
          var romaji_str = "";
          jpExp += " 【";
          for (let j = 0; j < glosses.length; j++) {
            const gloss = glosses[j];
            const hiragana = gloss.getElementsByTagName('dt')[0];
            if (j > 0) {
              jpExp += " - ";
              romaji_str += " ";
            }
            var word = hiragana.textContent;
            word = word.replace("1. ", "");
            word = word.replace("【", "<rt>");
            word = word.replace("】", "</rt>");
            word = "<ruby> " + word + "</ruby>";
            const romaji = gloss.getElementsByTagName('em')[0].textContent;
            romaji_str += romaji;
            jpExp += word;
          }
          jpExp += ` | ${romaji_str}】<br> `;
        }
        return jpExp;
      }
      catch (error) {
        console.log(`japanese_split: an error occurred: ${error}`);
        return "";
      }
    }
    function japaneseExplanationFile(text = "") {
      if (text === "") {
        text = jpExpInput.value;
        if (text === "") return;
      }
      var jpExpPromise = ScrapeJpExp(text);
      jpExpPromise.then(function(jpExp) {
        jpExpArea.html(formatJpExp(jpExp));
      })
    }
    function japaneseExplanationLocalhost(text = "") {
      if (text === "") {
        text = $('#jpExpInput').val();
        if (text === "") return;
      }
      $.ajax({
        url: '/process',
        type: 'POST',
        data: { jpExpInput: text },
        success: function(response) {
          jpExpArea.html(formatJpExp(response.result));
        }
      });
    }
    async function japaneseExplanationFromMyServer(text = "") {
      if (text === "") {
        text = $('#jpExpInput').val();
      }
      try {
          // const response = await fetch('http://localhost:3001/furigana', {
          const response = await fetch('https://snsmile.site:3001/furigana', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            text: text
          })
        })
        const data = await response.json();
        // var jpExpArea = $('#jpExpArea');
        // jpExpArea.html(response.result;);
        return data.result;
      } catch (error) {
        console.error('Error:', error);
        return text + "🌐🚨";
      }
    }
    function japaneseExplanationEntrance(text) {
      if (window.location.protocol === "file:") {
        console.log("japaneseExplanationFile()");
        japaneseExplanationFile(text);
      }
      else if (window.location.href.includes("localhost:")) {
        console.log("japaneseExplanationLocalhost()");
        japaneseExplanationLocalhost(text);
      }
      else {
        console.log("japaneseExplanationWebPage()");
        japaneseExplanationFile(text);
      }
    }
  </script>

  <span class="row-container">
    <button id="readingList_LayoutButton" style="margin-bottom:5px;" onclick="toggleWidgetArea('readingList', this)">Reading List ❌</button>
    <span style="margin-left:8px;"></span>
    <button id="favoriteList_LayoutButton" style="margin-bottom:5px;" onclick="toggleWidgetArea('favoriteList', this)">Favorite List ❌</button>
    <span style="margin-left:8px;"></span>
    <button id="speechList_LayoutButton" style="margin-bottom:5px;" onclick="toggleWidgetArea('speechList', this)">Speech List ❌</button>
  </span>

  <ul id="readingList" style="display:none"></ul>
  <span id="readingListTotalCount"></span>

  <ul id="favoriteList" style="display:none"></ul>

  <ul id="speechList" style="display:none"></ul>
  <span id="speechListTotalCount"></span>

  <span style="display: block">
    <div class="row-container">
      <ruby> 日本語<rt>にほんご</rt> &nbsp; </ruby>
      <ruby> 勉強<rt>べんきょう</rt> の &nbsp; </ruby>
      <ruby> 為<rt>ため</rt> に &nbsp; </ruby>
      <ruby> 自分<rt>じぶん</rt> で &nbsp; </ruby>
      <ruby> このサイトを<rt>.</rt> &nbsp; </ruby>
      <ruby> 作<rt>つく</rt> った &nbsp; </ruby>
      <ruby> by snowy_smile <rt>.</rt> </ruby>
    </div>

    <span style="display: none">
      <a href="https://wicg.github.io/speech-api" target="_blank">Speech Recognition</a>
      <a href="https://developer.mozilla.org/en-US/docs/Web/HTML" target="_blank">Web HTML Study</a>
    </span>
  </span>

  <script>
    function updateScreenWidth() {
      const screenWidth = window.innerWidth || document.documentElement.clientWidth;
      console.log("screenWidth:", screenWidth);
    }
    window.addEventListener('resize', updateScreenWidth);
    // updateScreenWidth();
  </script>

  <script> // Start
    var clearConfigs = false;
    if (clearConfigs) {
      localStorage.removeItem('snowyTranslatorConfig');
      for (let configID = 0; configID <= 2; configID++) {
        localStorage.removeItem(`snowyTranslatorTextConfig[${configID}]`);
      }
      // localStorage.clear();
    }
    initLayoutButtons();
    loadConfig(autoSID);
  </script>

</body>
</html>
